<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0A1628">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lincoln Shuttle">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <title>Lincoln Shuttle Dispatch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { font-family: 'Source Sans 3', sans-serif; background: #EEF2F9; color: #2D3A52; }
    select { border: none; outline: none; }
    button { border: none; outline: none; cursor: pointer; background: none; font-family: inherit; }
    input, select, textarea { font-family: inherit; }
    @keyframes micPulse {
      0%, 100% { box-shadow: 0 0 0 4px rgba(229,62,62,0.35), 0 0 0 8px rgba(229,62,62,0.15); }
      50%       { box-shadow: 0 0 0 8px rgba(229,62,62,0.25), 0 0 0 16px rgba(229,62,62,0.08); }
    }
    @keyframes toastIn  { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn   { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp  { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes spin     { to { transform: rotate(360deg); } }
    .ride-row:hover { background: #F0F6FF !important; }
    .action-btn:hover { opacity: 0.8; }
    .filter-select:focus { outline: 2px solid #1E4D8C; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #EEF2F9; }
    ::-webkit-scrollbar-thumb { background: #B0C4DE; border-radius: 3px; }
    .sync-spin { display: inline-block; animation: spin 1s linear infinite; }
  </style>
</head>
<body>
<div id="root"></div>

<!-- â•â•â• Storage Module (plain JS â€” no JSX) â•â•â• -->
<script>
const LS = {
  SCRIPT_KEY: 'ls-script-url',
  RIDES_KEY:  'ls-rides-cache',
  PENDING_KEY:'ls-pending-sync',

  getUrl()       { return localStorage.getItem(this.SCRIPT_KEY) || ''; },
  setUrl(url)    { localStorage.setItem(this.SCRIPT_KEY, url.trim()); },
  getCached()    { try { const s = localStorage.getItem(this.RIDES_KEY); return s ? JSON.parse(s) : null; } catch { return null; } },
  setCached(r)   { localStorage.setItem(this.RIDES_KEY, JSON.stringify(r)); },
  hasPending()   { return localStorage.getItem(this.PENDING_KEY) === 'true'; },
  setPending(v)  { v ? localStorage.setItem(this.PENDING_KEY,'true') : localStorage.removeItem(this.PENDING_KEY); },

  async fetchRides(onStatus) {
    const url = this.getUrl();
    if (!url) { onStatus('no-config'); return this.getCached(); }
    onStatus('syncing');
    try {
      const res = await fetch(url + '?action=getRides&t=' + Date.now());
      const data = await res.json();
      const rides = data.rides || [];
      this.setCached(rides);
      this.setPending(false);
      onStatus('synced');
      return rides;
    } catch {
      onStatus(navigator.onLine ? 'error' : 'offline');
      return this.getCached();
    }
  },

  async saveRides(rides, onStatus) {
    this.setCached(rides);
    const url = this.getUrl();
    if (!url) { onStatus('no-config'); return; }
    onStatus('syncing');
    try {
      await fetch(url, {
        method: 'POST',
        body: JSON.stringify({ action: 'saveRides', rides })
        // No Content-Type header â†’ avoids CORS preflight
      });
      this.setPending(false);
      onStatus('synced');
    } catch {
      this.setPending(true);
      onStatus(navigator.onLine ? 'error' : 'offline');
    }
  }
};
</script>

<!-- â•â•â• React App â•â•â• -->
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DRIVERS = ["Mike Johnson","Sarah Davis","Tom Rivera","Elena Patel","James Carter"];
const STATUS_OPTIONS = ["Scheduled","In Progress","Completed","Cancelled"];
const STATUS_STYLES = {
  "Scheduled":   { bg:"#EBF2FF", color:"#1E4D8C", border:"#93B8F0" },
  "In Progress": { bg:"#FFF8E6", color:"#B45309", border:"#FCD34D" },
  "Completed":   { bg:"#EDFAF3", color:"#065F46", border:"#6EE7B7" },
  "Cancelled":   { bg:"#FEF2F2", color:"#991B1B", border:"#FCA5A5" },
};
const EMPTY_FORM = { driver:DRIVERS[0], date:"", time:"", pickup:"", dropoff:"", fare:"", charge:"", tip:"", status:"Scheduled", passenger:"" };
const toDateStr = d => d.toISOString().slice(0,10);

const SAMPLE_RIDES = [
  { id:"LS-SUN1",    driver:"Mike Johnson",  date:"2026-02-15", time:"07:00", pickup:"Bangor International Airport",   dropoff:"Holiday Inn, Main St",          fare:"45.00",  charge:"45.00",  tip:"9.00",  status:"Completed", passenger:"Robert Haines" },
  { id:"LS-SUN2",    driver:"Sarah Davis",   date:"2026-02-15", time:"09:30", pickup:"Hampton Inn, Hogan Rd",          dropoff:"Bar Harbor, ME",                fare:"95.00",  charge:"100.00", tip:"20.00", status:"Completed", passenger:"Linda Torres" },
  { id:"LS-MON1",    driver:"Tom Rivera",    date:"2026-02-16", time:"08:00", pickup:"321 Union St, Bangor",           dropoff:"Eastern Maine Medical Center",  fare:"22.00",  charge:"22.00",  tip:"4.00",  status:"Completed", passenger:"James Whitfield" },
  { id:"LS-MON2",    driver:"Elena Patel",   date:"2026-02-16", time:"11:15", pickup:"University of Maine, Orono",     dropoff:"Bangor Mall",                   fare:"28.00",  charge:"30.00",  tip:"5.00",  status:"Completed", passenger:"Amara Singh" },
  { id:"LS-TUE1",    driver:"James Carter",  date:"2026-02-17", time:"06:30", pickup:"Cross Insurance Arena",          dropoff:"Bangor International Airport",  fare:"38.00",  charge:"38.00",  tip:"8.00",  status:"Completed", passenger:"Patricia Monroe" },
  { id:"LS-TUE2",    driver:"Mike Johnson",  date:"2026-02-17", time:"14:00", pickup:"Bangor Mall",                    dropoff:"Brewer, ME",                    fare:"18.00",  charge:"20.00",  tip:"3.00",  status:"Completed", passenger:"David Chen" },
  { id:"LS-WED1",    driver:"Sarah Davis",   date:"2026-02-18", time:"09:00", pickup:"Eastern Maine Medical Center",   dropoff:"Hampden, ME",                   fare:"32.00",  charge:"32.00",  tip:"6.00",  status:"Completed", passenger:"Grace Fuller" },
  { id:"LS-WED2",    driver:"Tom Rivera",    date:"2026-02-18", time:"13:30", pickup:"Bangor International Airport",   dropoff:"Ellsworth, ME",                 fare:"55.00",  charge:"60.00",  tip:"12.00", status:"Completed", passenger:"Carlos Reyes" },
  { id:"LS-THU1",    driver:"Elena Patel",   date:"2026-02-19", time:"07:45", pickup:"Holiday Inn, Main St",           dropoff:"Augusta, ME",                   fare:"75.00",  charge:"80.00",  tip:"15.00", status:"Completed", passenger:"Susan Park" },
  { id:"LS-THU2",    driver:"James Carter",  date:"2026-02-19", time:"15:00", pickup:"Brewer, ME",                     dropoff:"Bangor International Airport",  fare:"20.00",  charge:"20.00",  tip:"4.00",  status:"Completed", passenger:"Henry Walsh" },
  { id:"LS-FRI1",    driver:"Mike Johnson",  date:"2026-02-20", time:"08:30", pickup:"University of Maine, Orono",     dropoff:"Bar Harbor, ME",                fare:"90.00",  charge:"95.00",  tip:"18.00", status:"Scheduled", passenger:"Fiona Blake" },
  { id:"LS-FRI2",    driver:"Sarah Davis",   date:"2026-02-20", time:"12:00", pickup:"321 Union St, Bangor",           dropoff:"Rockland, ME",                  fare:"65.00",  charge:"65.00",  tip:"10.00", status:"Scheduled", passenger:"Omar Nasser" },
  { id:"LS-SAT1",    driver:"Tom Rivera",    date:"2026-02-21", time:"10:00", pickup:"Bangor International Airport",   dropoff:"Camden, ME",                    fare:"80.00",  charge:"85.00",  tip:"17.00", status:"Scheduled", passenger:"Anna Kowalski" },
  { id:"LS-SAT2",    driver:"Elena Patel",   date:"2026-02-21", time:"16:30", pickup:"Cross Insurance Arena",          dropoff:"Waterville, ME",                fare:"50.00",  charge:"50.00",  tip:"10.00", status:"Scheduled", passenger:"Marcus Bell" },
  { id:"LS-P-SUN1",  driver:"Mike Johnson",  date:"2026-02-08", time:"08:00", pickup:"Bangor Mall",                    dropoff:"Bangor International Airport",  fare:"20.00",  charge:"20.00",  tip:"4.00",  status:"Completed", passenger:"Tina Ford" },
  { id:"LS-P-SUN2",  driver:"Sarah Davis",   date:"2026-02-08", time:"11:00", pickup:"Hampton Inn, Hogan Rd",          dropoff:"Bar Harbor, ME",                fare:"95.00",  charge:"100.00", tip:"20.00", status:"Completed", passenger:"George Mills" },
  { id:"LS-P-MON1",  driver:"Tom Rivera",    date:"2026-02-09", time:"07:30", pickup:"321 Union St, Bangor",           dropoff:"Eastern Maine Medical Center",  fare:"22.00",  charge:"22.00",  tip:"4.00",  status:"Completed", passenger:"Claire Nguyen" },
  { id:"LS-P-MON2",  driver:"James Carter",  date:"2026-02-09", time:"14:00", pickup:"University of Maine, Orono",     dropoff:"Brewer, ME",                    fare:"30.00",  charge:"32.00",  tip:"6.00",  status:"Completed", passenger:"Ray Simmons" },
  { id:"LS-P-TUE1",  driver:"Elena Patel",   date:"2026-02-10", time:"09:00", pickup:"Cross Insurance Arena",          dropoff:"Bangor International Airport",  fare:"38.00",  charge:"38.00",  tip:"8.00",  status:"Completed", passenger:"Maya Patel" },
  { id:"LS-P-TUE2",  driver:"Mike Johnson",  date:"2026-02-10", time:"15:30", pickup:"Bangor International Airport",   dropoff:"Holiday Inn, Main St",          fare:"45.00",  charge:"45.00",  tip:"9.00",  status:"Completed", passenger:"Leo Byrne" },
  { id:"LS-P-WED1",  driver:"Sarah Davis",   date:"2026-02-11", time:"08:30", pickup:"Hampden, ME",                    dropoff:"Eastern Maine Medical Center",  fare:"28.00",  charge:"28.00",  tip:"5.00",  status:"Completed", passenger:"Nora Walsh" },
  { id:"LS-P-WED2",  driver:"Tom Rivera",    date:"2026-02-11", time:"13:00", pickup:"Ellsworth, ME",                  dropoff:"Bangor International Airport",  fare:"55.00",  charge:"60.00",  tip:"12.00", status:"Completed", passenger:"Ivan Petrov" },
  { id:"LS-P-THU1",  driver:"James Carter",  date:"2026-02-12", time:"07:00", pickup:"Augusta, ME",                    dropoff:"Bangor International Airport",  fare:"75.00",  charge:"80.00",  tip:"15.00", status:"Completed", passenger:"Diane Fox" },
  { id:"LS-P-THU2",  driver:"Elena Patel",   date:"2026-02-12", time:"16:00", pickup:"Brewer, ME",                     dropoff:"Bangor Mall",                   fare:"18.00",  charge:"18.00",  tip:"3.00",  status:"Completed", passenger:"Sam Ortega" },
  { id:"LS-P-FRI1",  driver:"Mike Johnson",  date:"2026-02-13", time:"09:00", pickup:"University of Maine, Orono",     dropoff:"Bar Harbor, ME",                fare:"90.00",  charge:"95.00",  tip:"18.00", status:"Completed", passenger:"Beth Larson" },
  { id:"LS-P-FRI2",  driver:"Sarah Davis",   date:"2026-02-13", time:"12:30", pickup:"321 Union St, Bangor",           dropoff:"Rockland, ME",                  fare:"65.00",  charge:"65.00",  tip:"10.00", status:"Completed", passenger:"Kwame Asante" },
  { id:"LS-P-SAT1",  driver:"Tom Rivera",    date:"2026-02-14", time:"10:00", pickup:"Bangor International Airport",   dropoff:"Camden, ME",                    fare:"80.00",  charge:"85.00",  tip:"17.00", status:"Completed", passenger:"Priya Sharma" },
  { id:"LS-P-SAT2",  driver:"James Carter",  date:"2026-02-14", time:"17:00", pickup:"Cross Insurance Arena",          dropoff:"Waterville, ME",                fare:"50.00",  charge:"50.00",  tip:"10.00", status:"Completed", passenger:"Owen Bradley" },
];

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genId() { return "LS-" + Date.now().toString(36).toUpperCase(); }
function formatCurrency(val) { const n = parseFloat(val); return isNaN(n) ? "â€”" : "$" + n.toFixed(2); }
function getShiftDate(now = new Date()) { const d = new Date(now); if (d.getHours() < 3) d.setDate(d.getDate()-1); return d; }
function firstName(name) { return name ? name.split(" ")[0] : "â€”"; }

function SyncBadge({ status }) {
  const map = {
    synced:    { dot:"#6EE7B7", label:"Synced",     spin:false },
    syncing:   { dot:"#93B8F0", label:"Syncingâ€¦",   spin:true  },
    offline:   { dot:"#FCD34D", label:"Offline",    spin:false },
    error:     { dot:"#FCA5A5", label:"Sync error", spin:false },
    'no-config':{ dot:"#9CA3AF",label:"Not set up", spin:false },
    loading:   { dot:"#93B8F0", label:"Loadingâ€¦",   spin:true  },
  };
  const s = map[status] || map['no-config'];
  return (
    <div style={{ display:"flex", alignItems:"center", gap:4, fontSize:9, color:"rgba(255,255,255,0.7)", fontFamily:"'Source Sans 3', sans-serif" }}>
      <span className={s.spin ? "sync-spin" : ""} style={{ display:"inline-block", width:7, height:7, borderRadius:"50%", background: s.dot }}></span>
      {s.label}
    </div>
  );
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [rides,         setRides]         = useState([]);
  const [loading,       setLoading]       = useState(true);
  const [syncStatus,    setSyncStatus]    = useState('loading');
  const [showModal,     setShowModal]     = useState(false);
  const [editRide,      setEditRide]      = useState(null);
  const [form,          setForm]          = useState(EMPTY_FORM);
  const [filterStatus,  setFilterStatus]  = useState("All");
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [toast,         setToast]         = useState(null);
  const [listening,     setListening]     = useState(false);
  const [voicePickup,   setVoicePickup]   = useState(null);
  const [checkedRides,  setCheckedRides]  = useState({});
  const [showSettings,  setShowSettings]  = useState(false);
  const [settingsUrl,   setSettingsUrl]   = useState('');
  const [settingsTesting, setSettingsTesting] = useState(false);
  const [statsDriver,   setStatsDriver]   = useState(DRIVERS[0]);
  const [rollingDriver, setRollingDriver] = useState(DRIVERS[0]);
  const [rollingOpen,   setRollingOpen]   = useState(false);
  const [openDays,      setOpenDays]      = useState(() => {
    const d = getShiftDate(); return { [toDateStr(d)]: true };
  });
  const [prevSectionOpen,  setPrevSectionOpen]  = useState(false);
  const [prevStatsDriver,  setPrevStatsDriver]  = useState(DRIVERS[0]);
  const [prevRollingDriver,setPrevRollingDriver] = useState(DRIVERS[0]);
  const [prevRollingOpen,  setPrevRollingOpen]  = useState(false);
  const [prevOpenDays,     setPrevOpenDays]     = useState({});
  const [selectedWeekSunStr, setSelectedWeekSunStr] = useState(() => {
    const d = getShiftDate();
    const sun = new Date(d); sun.setDate(d.getDate() - d.getDay() - 7);
    return toDateStr(sun);
  });
  const recognitionRef = React.useRef(null);

  // â”€â”€ Load on mount â”€â”€
  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
    LS.fetchRides(setSyncStatus).then(fetched => {
      if (fetched && fetched.length > 0) {
        setRides(fetched);
      } else {
        setRides(SAMPLE_RIDES);
        LS.setCached(SAMPLE_RIDES);
      }
      setLoading(false);
    });
    setSettingsUrl(LS.getUrl());

    // Auto-sync when coming back online
    const handleOnline = () => {
      if (LS.hasPending()) {
        const cached = LS.getCached();
        if (cached) LS.saveRides(cached, setSyncStatus);
      }
    };
    window.addEventListener('online', handleOnline);
    return () => window.removeEventListener('online', handleOnline);
  }, []);

  // â”€â”€ Core actions â”€â”€
  async function saveRides(updated) {
    setRides(updated);
    await LS.saveRides(updated, setSyncStatus);
  }

  function showToast(msg) { setToast(msg); setTimeout(() => setToast(null), 2800); }
  function toggleCheck(id) { setCheckedRides(p => ({ ...p, [id]: !p[id] })); }
  function toggleDay(ds)     { setOpenDays(p => ({ ...p, [ds]: !p[ds] })); }
  function togglePrevDay(ds) { setPrevOpenDays(p => ({ ...p, [ds]: !p[ds] })); }

  function openNew() {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    setEditRide(null);
    setForm({ ...EMPTY_FORM, date: toDateStr(getShiftDate(now)), time: `${hh}:${mm}` });
    setShowModal(true);
  }

  function openEdit(ride) { setEditRide(ride.id); setForm({ ...ride }); setShowModal(true); }

  async function handleSave() {
    if (!editRide && !form.pickup) return;
    if (editRide && (!form.date || !form.time || !form.pickup)) return;
    if (editRide) {
      await saveRides(rides.map(r => r.id === editRide ? { ...form, id: editRide } : r));
      showToast("Ride updated.");
    } else {
      await saveRides([{ ...form, id: genId() }, ...rides]);
      showToast("Ride booked.");
    }
    setShowModal(false);
  }

  async function handleDelete(id) {
    await saveRides(rides.filter(r => r.id !== id));
    setDeleteConfirm(null);
    showToast("Ride removed.");
  }

  function startVoice() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { showToast("Voice not supported â€” use Chrome."); return; }
    if (listening) return;
    const rec = new SR();
    rec.lang = "en-US"; rec.interimResults = false; rec.maxAlternatives = 1;
    recognitionRef.current = rec;
    setListening(true);
    rec.onresult = e => {
      const text = e.results[0][0].transcript;
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      setVoicePickup({ text, date: toDateStr(getShiftDate(now)), time: `${hh}:${mm}` });
      setListening(false);
    };
    rec.onerror = () => { setListening(false); showToast("Couldn't hear that â€” try again."); };
    rec.onend   = () => setListening(false);
    rec.start();
  }

  async function confirmVoiceRide() {
    if (!voicePickup) return;
    const nr = { ...EMPTY_FORM, id: genId(), pickup: voicePickup.text, date: voicePickup.date, time: voicePickup.time, status: "Scheduled" };
    await saveRides([nr, ...rides]);
    setVoicePickup(null);
    showToast("Ride booked â€” " + voicePickup.text);
  }

  async function handleSettingsSave() {
    LS.setUrl(settingsUrl);
    setShowSettings(false);
    setSyncStatus('syncing');
    const fetched = await LS.fetchRides(setSyncStatus);
    if (fetched && fetched.length > 0) { setRides(fetched); showToast("Connected & synced!"); }
    else showToast("Saved â€” no rides in sheet yet.");
  }

  async function handleSettingsTest() {
    if (!settingsUrl.trim()) { showToast("Enter your Apps Script URL first."); return; }
    setSettingsTesting(true);
    try {
      const res = await fetch(settingsUrl.trim() + '?action=getRides&t=' + Date.now());
      const data = await res.json();
      showToast(`âœ“ Connected! ${(data.rides||[]).length} rides in sheet.`);
    } catch {
      showToast("âœ— Connection failed â€” check the URL.");
    }
    setSettingsTesting(false);
  }

  // â”€â”€ Date calculations â”€â”€
  const shiftNow   = getShiftDate();
  const weekSunday = new Date(shiftNow); weekSunday.setDate(shiftNow.getDate() - shiftNow.getDay());
  const weekSat    = new Date(weekSunday); weekSat.setDate(weekSunday.getDate() + 6);
  const weekStart  = toDateStr(weekSunday);
  const weekEnd    = toDateStr(weekSat);
  const weekLabel  = weekSunday.toLocaleDateString("en-US",{month:"short",day:"numeric"}) + " â€“ " + weekSat.toLocaleDateString("en-US",{month:"short",day:"numeric"});

  const weekRides   = rides.filter(r => r.date >= weekStart && r.date <= weekEnd && r.driver === statsDriver);
  const weekFare    = weekRides.reduce((a,r) => a+(parseFloat(r.fare)||0), 0);
  const weekCharge  = weekRides.reduce((a,r) => a+(parseFloat(r.charge)||0), 0);
  const weekTip     = weekRides.reduce((a,r) => a+(parseFloat(r.tip)||0), 0);

  const weekDays = Array.from({length:7},(_,i)=>{
    const d = new Date(weekSunday); d.setDate(weekSunday.getDate()+i);
    return { dateStr:toDateStr(d), label:d.toLocaleDateString("en-US",{weekday:"long"}), short:d.toLocaleDateString("en-US",{month:"short",day:"numeric"}), isToday: toDateStr(d)===toDateStr(getShiftDate()) };
  });

  const selectedSun = new Date(selectedWeekSunStr+"T12:00:00");
  const selectedSat = new Date(selectedSun); selectedSat.setDate(selectedSun.getDate()+6);
  const prevStart   = toDateStr(selectedSun), prevEnd = toDateStr(selectedSat);
  const prevLabel   = selectedSun.toLocaleDateString("en-US",{month:"short",day:"numeric"}) + " â€“ " + selectedSat.toLocaleDateString("en-US",{month:"short",day:"numeric"});

  const prevWeekRides  = rides.filter(r => r.date>=prevStart && r.date<=prevEnd && r.driver===prevStatsDriver);
  const prevWeekFare   = prevWeekRides.reduce((a,r)=>a+(parseFloat(r.fare)||0),0);
  const prevWeekCharge = prevWeekRides.reduce((a,r)=>a+(parseFloat(r.charge)||0),0);
  const prevWeekTip    = prevWeekRides.reduce((a,r)=>a+(parseFloat(r.tip)||0),0);

  const prevDays = Array.from({length:7},(_,i)=>{
    const d = new Date(selectedSun); d.setDate(selectedSun.getDate()+i);
    return { dateStr:toDateStr(d), label:d.toLocaleDateString("en-US",{weekday:"long"}), short:d.toLocaleDateString("en-US",{month:"short",day:"numeric"}), isToday:false };
  });

  const allWeeks = (() => {
    const weeks = []; const start = new Date("2026-01-04T12:00:00");
    const curr = new Date(weekSunday); curr.setHours(12,0,0,0);
    const d = new Date(start);
    while (d < curr) {
      const sat = new Date(d); sat.setDate(d.getDate()+6);
      weeks.push({ sunStr: toDateStr(d), label: d.toLocaleDateString("en-US",{month:"short",day:"numeric"})+" â€“ "+sat.toLocaleDateString("en-US",{month:"short",day:"numeric"}) });
      d.setDate(d.getDate()+7);
    }
    return weeks.reverse();
  })();

  const filtered = rides.filter(r => filterStatus==="All" || r.status===filterStatus)
    .sort((a,b) => ((b.date||"")+(b.time||"")).localeCompare((a.date||"")+(a.time||"")));

  // â”€â”€ Reusable ride row renderer â”€â”€
  function RideRow({ ride, i }) {
    const st = STATUS_STYLES[ride.status] || STATUS_STYLES["Scheduled"];
    const n  = parseFloat(ride.fare);
    const fareStr = isNaN(n) ? "" : "$"+(n%1===0?n.toFixed(0):n.toFixed(2));
    return (
      <tr className="ride-row" style={{ background: i%2===0?"#fff":"#F8FAFF", borderBottom:"1px solid #EBF0FA" }}>
        <td style={{ padding:"5px 10px", overflow:"hidden", maxWidth:0, width:"100%" }}>
          <div style={{ display:"flex", alignItems:"center", gap:7, minWidth:0 }}>
            <input type="checkbox" checked={!!checkedRides[ride.id]} onChange={()=>toggleCheck(ride.id)}
              style={{ accentColor:"#1E4D8C", width:12, height:12, cursor:"pointer", flexShrink:0 }}/>
            <span style={{ color:"#2D3A52", fontWeight:700, fontSize:12.5, flexShrink:0 }}>{firstName(ride.driver)}</span>
            <span style={{ color:"#2D3A52", flex:1, minWidth:0, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap" }}
              title={`${ride.pickup||""}${ride.dropoff?" to "+ride.dropoff:""}${ride.fare?" "+fareStr:""}${ride.charge?" Charge $"+parseFloat(ride.charge).toFixed(2):""}`}>
              {ride.pickup||"â€”"}
              {ride.dropoff ? <span style={{color:"#6B87B0"}}> to </span> : ""}
              {ride.dropoff||""}
              {ride.fare ? <span style={{color:"#0A1628",fontWeight:700}}> {fareStr}</span> : ""}
              {ride.charge ? <span style={{color:"#0A1628",fontWeight:700}}> Charge ${parseFloat(ride.charge).toFixed(2)}</span> : ""}
            </span>
            <span style={{ background:st.bg, color:st.color, border:`1px solid ${st.border}`, borderRadius:20, padding:"0 7px", fontSize:9.5, fontWeight:600, flexShrink:0, display:"inline-flex", alignItems:"center", height:18 }}>{ride.status}</span>
            <button className="action-btn" onClick={()=>openEdit(ride)} style={{ background:"#EBF2FF", color:"#1E4D8C", borderRadius:4, padding:"0 6px", fontSize:9.5, fontWeight:600, flexShrink:0, display:"inline-flex", alignItems:"center", height:18 }}>Edit</button>
            <button className="action-btn" onClick={()=>setDeleteConfirm(ride.id)} style={{ background:"#FEF2F2", color:"#991B1B", borderRadius:4, padding:"0 6px", fontSize:9.5, fontWeight:600, flexShrink:0, display:"inline-flex", alignItems:"center", height:18 }}>Delete</button>
          </div>
        </td>
      </tr>
    );
  }

  function DaySection({ day, dayRides, isOpen, onToggle }) {
    return (
      <div style={{ background:"#fff", borderRadius:10, boxShadow:"0 1px 6px rgba(30,77,140,0.08)", overflow:"hidden", border: day.isToday?"2px solid #1E4D8C":"2px solid transparent" }}>
        <div style={{ background: day.isToday?"linear-gradient(135deg,#0A1628,#1E4D8C)":"linear-gradient(135deg,#2D3A52,#4A6A9C)", padding:"6px 12px", display:"flex", alignItems:"center", justifyContent:"space-between", cursor:"pointer" }}
          onClick={onToggle}>
          <div style={{ display:"flex", alignItems:"center", gap:8 }}>
            <span style={{ fontFamily:"'Oswald',sans-serif", fontWeight:700, fontSize:12, color:"#fff", letterSpacing:1.2 }}>{day.label.toUpperCase()}</span>
            <span style={{ fontSize:10, color:"rgba(255,255,255,0.6)" }}>{day.short}</span>
            {day.isToday && <span style={{ background:"rgba(255,255,255,0.2)", color:"#fff", fontSize:9, fontWeight:700, padding:"1px 6px", borderRadius:10, letterSpacing:.8 }}>TODAY</span>}
          </div>
          <span style={{ fontSize:10, color:"rgba(255,255,255,0.6)" }}>{dayRides.length} ride{dayRides.length!==1?"s":""}</span>
        </div>
        {isOpen && (dayRides.length===0 ? (
          <div style={{ padding:"8px 12px", fontSize:11, color:"#C0CCDE", fontStyle:"italic" }}>No rides scheduled</div>
        ) : (
          <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12.5 }}>
            <tbody>{dayRides.map((r,i) => <RideRow key={r.id} ride={r} i={i}/>)}</tbody>
          </table>
        ))}
      </div>
    );
  }

  function RollingTable({ days, driver }) {
    let running = 0;
    return (
      <table style={{ width:"100%", borderCollapse:"collapse", fontSize:11.5 }}>
        <thead>
          <tr style={{ background:"#F0F4FB" }}>
            {["Day","Day Fares","Running Total"].map(h=>(
              <th key={h} style={{ padding:"5px 12px", textAlign:h==="Day"?"left":"right", fontFamily:"'Oswald',sans-serif", fontSize:10, fontWeight:600, color:"#6B87B0", letterSpacing:1, textTransform:"uppercase" }}>{h}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {days.map((day,i) => {
            const df = rides.filter(r=>r.date===day.dateStr&&r.driver===driver).reduce((a,r)=>a+(parseFloat(r.fare)||0),0);
            running += df;
            const has = df > 0;
            return (
              <tr key={day.dateStr} style={{ borderBottom:"1px solid #EBF0FA", background:day.isToday?"#EBF2FF":i%2===0?"#fff":"#F8FAFF" }}>
                <td style={{ padding:"5px 12px", color:day.isToday?"#1E4D8C":"#2D3A52", fontWeight:day.isToday?700:400 }}>
                  {day.label} <span style={{color:"#9FB4D0",fontSize:10}}>{day.short}</span>
                  {day.isToday && <span style={{marginLeft:6,background:"#1E4D8C",color:"#fff",fontSize:8,fontWeight:700,padding:"1px 5px",borderRadius:8}}>TODAY</span>}
                </td>
                <td style={{ padding:"5px 12px", textAlign:"right", color:has?"#0A1628":"#C0CCDE", fontWeight:has?600:400 }}>{has?"$"+df.toFixed(2):"â€”"}</td>
                <td style={{ padding:"5px 12px", textAlign:"right", fontFamily:"'Oswald',sans-serif", fontWeight:700, fontSize:13, color:running>0?"#065F46":"#C0CCDE" }}>{running>0?"$"+running.toFixed(2):"â€”"}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    );
  }

  function DriverSelect({ value, onChange, light }) {
    return (
      <div style={{ position:"relative", display:"inline-flex", alignItems:"center" }}>
        <select value={value} onChange={e=>onChange(e.target.value)}
          style={{ border: light?"none":"1.5px solid #D1DEFA", borderRadius:6, padding:"2px 24px 2px 8px", fontSize:11, color:"#0A1628", fontFamily:"'Source Sans 3',sans-serif", cursor:"pointer", background: light?"#fff":"#F5F8FF", appearance:"none" }}>
          {DRIVERS.map(d=><option key={d}>{d}</option>)}
        </select>
        <span style={{ position:"absolute", right:7, pointerEvents:"none", fontSize:10, color:"#1E4D8C" }}>â–¼</span>
      </div>
    );
  }

  if (loading) return (
    <div style={{ background:"#EEF2F9", minHeight:"100vh", display:"flex", alignItems:"center", justifyContent:"center" }}>
      <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:24, color:"#1E4D8C", letterSpacing:2 }}>LOADINGâ€¦</div>
    </div>
  );

  // â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <>
      {/* GLOBAL STYLES */}
      <style>{`
        @keyframes micPulse { 0%,100%{box-shadow:0 0 0 4px rgba(229,62,62,.35),0 0 0 8px rgba(229,62,62,.15)} 50%{box-shadow:0 0 0 8px rgba(229,62,62,.25),0 0 0 16px rgba(229,62,62,.08)} }
        @keyframes toastIn  { from{transform:translateX(110%);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes spin     { to{transform:rotate(360deg)} }
        .sync-spin { display:inline-block; animation:spin 1s linear infinite; }
        .ride-row:hover { background:#F0F6FF !important; }
        .action-btn:hover { opacity:.8; }
        .modal-overlay { animation:fadeIn .15s ease; }
        .modal-box     { animation:slideUp .2s ease; }
        @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }
      `}</style>

      <div style={{ minHeight:"100vh", background:"#EEF2F9" }}>

        {/* â”€â”€ HEADER â”€â”€ */}
        <header style={{ background:"linear-gradient(135deg,#0A1628 0%,#1E4D8C 100%)", padding:"0 16px", display:"flex", alignItems:"center", justifyContent:"space-between", height:54, boxShadow:"0 2px 12px rgba(10,22,40,.35)", position:"sticky", top:0, zIndex:100 }}>
          <div style={{ display:"flex", alignItems:"center", gap:10 }}>
            <div style={{ background:"#fff", borderRadius:6, width:34, height:34, display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0 }}>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M3 17h2a2 2 0 004 0h6a2 2 0 004 0h2V9l-3-5H6L3 9v8z" fill="#1E4D8C"/>
                <circle cx="7" cy="17" r="1.5" fill="white"/><circle cx="17" cy="17" r="1.5" fill="white"/>
                <path d="M3 13h18" stroke="white" strokeWidth="1.2"/>
              </svg>
            </div>
            <div>
              <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:16, fontWeight:700, color:"#fff", letterSpacing:2, lineHeight:1 }}>LINCOLN SHUTTLE</div>
              <div style={{ fontSize:9, color:"#93B8F0", letterSpacing:1.5, marginTop:1 }}>DISPATCH DASHBOARD</div>
            </div>
          </div>

          <div style={{ display:"flex", alignItems:"center", gap:10 }}>
            <div style={{ textAlign:"right" }}>
              <div style={{ fontSize:9, color:"#93B8F0" }}>{new Date().toLocaleDateString("en-US",{weekday:"long"})}</div>
              <div style={{ fontSize:10, color:"#fff", fontWeight:600 }}>{new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}</div>
              <SyncBadge status={syncStatus}/>
            </div>

            {/* Settings gear */}
            <button onClick={()=>{ setSettingsUrl(LS.getUrl()); setShowSettings(true); }}
              style={{ color:"rgba(255,255,255,0.7)", fontSize:18, padding:4, borderRadius:6, lineHeight:1 }} title="Settings">âš™</button>

            {/* Voice button */}
            <div style={{ display:"flex", flexDirection:"column", alignItems:"center", gap:2 }}>
              <button onClick={startVoice}
                style={{ width:38, height:38, borderRadius:"50%", border:"none", cursor:listening?"default":"pointer", background:listening?"#E53E3E":"#fff",
                  boxShadow:listening?"0 0 0 4px rgba(229,62,62,.35),0 0 0 8px rgba(229,62,62,.15)":"0 2px 10px rgba(255,255,255,.2)",
                  display:"flex", alignItems:"center", justifyContent:"center",
                  animation:listening?"micPulse 1.2s ease-in-out infinite":"none", transition:"background .2s,box-shadow .2s" }}>
                <svg width="17" height="17" viewBox="0 0 24 24" fill="none">
                  <rect x="9" y="2" width="6" height="12" rx="3" fill={listening?"#fff":"#0A1628"}/>
                  <path d="M5 11a7 7 0 0014 0" stroke={listening?"#fff":"#0A1628"} strokeWidth="2" strokeLinecap="round"/>
                  <line x1="12" y1="18" x2="12" y2="22" stroke={listening?"#fff":"#0A1628"} strokeWidth="2" strokeLinecap="round"/>
                  <line x1="8" y1="22" x2="16" y2="22" stroke={listening?"#fff":"#0A1628"} strokeWidth="2" strokeLinecap="round"/>
                </svg>
              </button>
              <span style={{ fontSize:8, color:listening?"#FCA5A5":"#93B8F0", letterSpacing:.8, fontFamily:"'Oswald',sans-serif" }}>
                {listening?"LISTENINGâ€¦":"NEW RIDE"}
              </span>
            </div>

            <button onClick={openNew}
              style={{ background:"rgba(255,255,255,.12)", color:"#fff", border:"1px solid rgba(255,255,255,.25)", borderRadius:6, padding:"6px 10px", fontFamily:"'Oswald',sans-serif", fontWeight:600, fontSize:11, letterSpacing:1 }}>
              MANUAL
            </button>
          </div>
        </header>

        <div style={{ padding:"14px 16px", maxWidth:1200, margin:"0 auto" }}>

          {/* â”€â”€ STATS â”€â”€ */}
          <div style={{ marginBottom:8 }}>
            <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:6 }}>
              <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:10, color:"#6B87B0", letterSpacing:1.5 }}>CURRENT WEEK Â· {weekLabel}</div>
              <DriverSelect value={statsDriver} onChange={setStatsDriver}/>
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:10, marginBottom:10 }}>
              {[{label:"Total Fares",value:"$"+weekFare.toFixed(2),icon:"ðŸ§¾"},{label:"Total Charges",value:"$"+weekCharge.toFixed(2),icon:"ðŸ’³"},{label:"Total Tips",value:"$"+weekTip.toFixed(2),icon:"ðŸ’°"}].map(s=>(
                <div key={s.label} style={{ background:"#fff", borderRadius:8, padding:"10px 14px", boxShadow:"0 1px 4px rgba(30,77,140,.08)", borderTop:"2px solid #1E4D8C" }}>
                  <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                    <div>
                      <div style={{ fontSize:9, fontWeight:600, color:"#6B87B0", letterSpacing:1.2, textTransform:"uppercase" }}>{s.label}</div>
                      <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:22, fontWeight:700, color:"#0A1628", lineHeight:1.1 }}>{s.value}</div>
                    </div>
                    <span style={{fontSize:20}}>{s.icon}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* â”€â”€ DAILY SECTIONS â”€â”€ */}
          <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
            {weekDays.map(day => {
              const dayRides = filtered.filter(r => r.date===day.dateStr);
              return <DaySection key={day.dateStr} day={day} dayRides={dayRides} isOpen={!!openDays[day.dateStr]} onToggle={()=>toggleDay(day.dateStr)}/>;
            })}
          </div>

          {/* â”€â”€ ROLLING TOTALS â”€â”€ */}
          <div style={{ background:"#fff", borderRadius:10, boxShadow:"0 1px 6px rgba(30,77,140,.08)", overflow:"hidden", marginTop:10 }}>
            <div style={{ background:"linear-gradient(135deg,#0A1628,#1E4D8C)", padding:"6px 12px", display:"flex", alignItems:"center", justifyContent:"space-between", cursor:"pointer" }}
              onClick={()=>setRollingOpen(o=>!o)}>
              <span style={{ fontFamily:"'Oswald',sans-serif", fontWeight:700, fontSize:11, color:"#fff", letterSpacing:1.2 }}>ROLLING WEEK TOTALS</span>
              <div onClick={e=>e.stopPropagation()}>
                <DriverSelect value={rollingDriver} onChange={setRollingDriver} light/>
              </div>
            </div>
            {rollingOpen && <RollingTable days={weekDays} driver={rollingDriver}/>}
          </div>

          {/* â”€â”€ WEEK HISTORY â”€â”€ */}
          <div style={{ marginTop:14 }}>
            <div onClick={()=>setPrevSectionOpen(o=>!o)} style={{ background:"linear-gradient(135deg,#1A2A40,#2D4A7A)", borderRadius:prevSectionOpen?"10px 10px 0 0":10, padding:"8px 14px", display:"flex", alignItems:"center", justifyContent:"space-between", cursor:"pointer", boxShadow:"0 1px 6px rgba(30,77,140,.12)" }}>
              <span style={{ fontFamily:"'Oswald',sans-serif", fontWeight:700, fontSize:13, color:"#fff", letterSpacing:1.5 }}>WEEK HISTORY</span>
              <div style={{ display:"flex", alignItems:"center", gap:10 }}>
                <div onClick={e=>e.stopPropagation()} style={{ position:"relative", display:"inline-flex", alignItems:"center" }}>
                  <select value={selectedWeekSunStr} onChange={e=>{setSelectedWeekSunStr(e.target.value);setPrevOpenDays({});}}
                    style={{ border:"none", borderRadius:5, padding:"2px 24px 2px 8px", fontSize:11, color:"#0A1628", fontFamily:"'Source Sans 3',sans-serif", cursor:"pointer", background:"#fff", appearance:"none", maxWidth:160 }}>
                    {allWeeks.map(w=><option key={w.sunStr} value={w.sunStr}>{w.label}</option>)}
                  </select>
                  <span style={{ position:"absolute", right:6, pointerEvents:"none", fontSize:10, color:"#1E4D8C" }}>â–¼</span>
                </div>
                <span style={{ color:"rgba(255,255,255,.6)", fontSize:11 }}>{prevSectionOpen?"â–²":"â–¼"}</span>
              </div>
            </div>

            {prevSectionOpen && (
              <div style={{ background:"#E8EDF5", borderRadius:"0 0 10px 10px", padding:"12px 12px 8px" }}>
                {/* Prev stats */}
                <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:6 }}>
                  <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:10, color:"#6B87B0", letterSpacing:1.5 }}>WEEK TOTALS Â· {prevLabel}</div>
                  <DriverSelect value={prevStatsDriver} onChange={setPrevStatsDriver}/>
                </div>
                <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:8, marginBottom:10 }}>
                  {[{label:"Total Fares",value:"$"+prevWeekFare.toFixed(2),icon:"ðŸ§¾"},{label:"Total Charges",value:"$"+prevWeekCharge.toFixed(2),icon:"ðŸ’³"},{label:"Total Tips",value:"$"+prevWeekTip.toFixed(2),icon:"ðŸ’°"}].map(s=>(
                    <div key={s.label} style={{ background:"#fff", borderRadius:8, padding:"10px 12px", boxShadow:"0 1px 4px rgba(30,77,140,.07)", borderTop:"2px solid #4A6A9C" }}>
                      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center" }}>
                        <div>
                          <div style={{ fontSize:9, fontWeight:600, color:"#6B87B0", letterSpacing:1.2, textTransform:"uppercase" }}>{s.label}</div>
                          <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:20, fontWeight:700, color:"#0A1628", lineHeight:1.1 }}>{s.value}</div>
                        </div>
                        <span style={{fontSize:18}}>{s.icon}</span>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Prev daily sections */}
                <div style={{ display:"flex", flexDirection:"column", gap:7, marginBottom:10 }}>
                  {prevDays.map(day => {
                    const dayRides = rides.filter(r => r.date===day.dateStr);
                    return <DaySection key={day.dateStr} day={day} dayRides={dayRides} isOpen={!!prevOpenDays[day.dateStr]} onToggle={()=>togglePrevDay(day.dateStr)}/>;
                  })}
                </div>

                {/* Prev rolling */}
                <div style={{ background:"#fff", borderRadius:8, overflow:"hidden", boxShadow:"0 1px 4px rgba(30,77,140,.07)" }}>
                  <div style={{ background:"linear-gradient(135deg,#2D3A52,#4A6A9C)", padding:"6px 12px", display:"flex", alignItems:"center", justifyContent:"space-between", cursor:"pointer" }}
                    onClick={()=>setPrevRollingOpen(o=>!o)}>
                    <span style={{ fontFamily:"'Oswald',sans-serif", fontWeight:700, fontSize:11, color:"#fff", letterSpacing:1.2 }}>ROLLING WEEK TOTALS</span>
                    <div onClick={e=>e.stopPropagation()}>
                      <DriverSelect value={prevRollingDriver} onChange={setPrevRollingDriver} light/>
                    </div>
                  </div>
                  {prevRollingOpen && <RollingTable days={prevDays} driver={prevRollingDriver}/>}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* â”€â”€ SETTINGS MODAL â”€â”€ */}
      {showSettings && (
        <div className="modal-overlay" onClick={()=>setShowSettings(false)}
          style={{ position:"fixed", inset:0, background:"rgba(10,22,40,.65)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000, padding:20 }}>
          <div className="modal-box" onClick={e=>e.stopPropagation()}
            style={{ background:"#fff", borderRadius:16, width:"100%", maxWidth:500, boxShadow:"0 20px 60px rgba(10,22,40,.35)", overflow:"hidden" }}>
            <div style={{ background:"linear-gradient(135deg,#0A1628,#1E4D8C)", padding:"18px 24px", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
              <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:17, fontWeight:700, color:"#fff", letterSpacing:1.5 }}>âš™ SETTINGS</div>
              <button onClick={()=>setShowSettings(false)} style={{ background:"rgba(255,255,255,.15)", color:"#fff", width:28, height:28, borderRadius:"50%", fontSize:15, display:"flex", alignItems:"center", justifyContent:"center" }}>âœ•</button>
            </div>
            <div style={{ padding:"20px 24px", display:"flex", flexDirection:"column", gap:16 }}>
              <div>
                <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:13, fontWeight:600, color:"#0A1628", letterSpacing:.8, marginBottom:6 }}>GOOGLE APPS SCRIPT URL</div>
                <input value={settingsUrl} onChange={e=>setSettingsUrl(e.target.value)} placeholder="https://script.google.com/macros/s/â€¦/exec"
                  style={{ width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"9px 12px", fontSize:12, color:"#0A1628", background:"#F5F8FF", outline:"none" }}/>
                <div style={{ fontSize:11, color:"#6B87B0", marginTop:6 }}>
                  Paste the URL from your deployed Google Apps Script. See SETUP.md for instructions.
                </div>
              </div>
              <div style={{ background:"#F0F4FB", borderRadius:8, padding:"10px 14px", fontSize:11.5, color:"#4A6A9C", lineHeight:1.6 }}>
                <strong>Sync status:</strong> {syncStatus} &nbsp;Â·&nbsp;
                {LS.hasPending() ? <span style={{color:"#B45309"}}>âš  Unsynced local changes</span> : <span style={{color:"#065F46"}}>âœ“ Up to date</span>}
              </div>
              <div style={{ display:"flex", gap:10 }}>
                <button onClick={handleSettingsTest} disabled={settingsTesting}
                  style={{ flex:1, background:"#F0F4FB", color:"#1E4D8C", borderRadius:8, padding:"9px", fontSize:13, fontWeight:600, fontFamily:"'Oswald',sans-serif", letterSpacing:.8, opacity:settingsTesting?.6:1 }}>
                  {settingsTesting?"TESTINGâ€¦":"TEST CONNECTION"}
                </button>
                <button onClick={handleSettingsSave}
                  style={{ flex:2, background:"linear-gradient(135deg,#0A1628,#1E4D8C)", color:"#fff", borderRadius:8, padding:"9px", fontSize:13, fontWeight:600, fontFamily:"'Oswald',sans-serif", letterSpacing:.8 }}>
                  SAVE & SYNC
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ ADD / EDIT MODAL â”€â”€ */}
      {showModal && (
        <div className="modal-overlay" onClick={()=>setShowModal(false)}
          style={{ position:"fixed", inset:0, background:"rgba(10,22,40,.6)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000, padding:20 }}>
          <div className="modal-box" onClick={e=>e.stopPropagation()}
            style={{ background:"#fff", borderRadius:16, width:"100%", maxWidth:540, boxShadow:"0 20px 60px rgba(10,22,40,.35)", overflow:"hidden" }}>
            <div style={{ background:"linear-gradient(135deg,#0A1628,#1E4D8C)", padding:"18px 24px", display:"flex", justifyContent:"space-between", alignItems:"center" }}>
              <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:17, fontWeight:700, color:"#fff", letterSpacing:1.5 }}>{editRide?"EDIT RIDE":"BOOK NEW RIDE"}</div>
              <button onClick={()=>setShowModal(false)} style={{ background:"rgba(255,255,255,.15)", color:"#fff", width:28, height:28, borderRadius:"50%", fontSize:15, display:"flex", alignItems:"center", justifyContent:"center" }}>âœ•</button>
            </div>
            <div style={{ padding:"20px 24px", display:"grid", gridTemplateColumns:"1fr 1fr", gap:14, maxHeight:"70vh", overflowY:"auto" }}>
              {!editRide ? (
                <div style={{ gridColumn:"span 2" }}>
                  <div style={{ background:"#F0F4FB", borderRadius:8, padding:"9px 12px", marginBottom:12, fontSize:12, color:"#4A6A9C" }}>
                    ðŸ“… Auto-set to {form.date} at {form.time} Â· Status: <strong>Scheduled</strong>
                  </div>
                  <label style={{ display:"block", fontSize:11, fontWeight:600, color:"#6B87B0", letterSpacing:.8, marginBottom:4 }}>PICKUP ADDRESS *</label>
                  <input autoFocus value={form.pickup} onChange={e=>setForm(f=>({...f,pickup:e.target.value}))} placeholder="e.g. Bangor International Airport"
                    style={{ width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"9px 12px", fontSize:13, outline:"none" }}/>
                </div>
              ) : (
                <>
                  {[{k:"passenger",l:"Passenger Name"},{k:"date",l:"Date *",t:"date"},{k:"time",l:"Time *",t:"time"},{k:"pickup",l:"Pickup Address *"},{k:"dropoff",l:"Dropoff Address"}].map(({k,l,t})=>(
                    <div key={k} style={{ gridColumn: (k==="pickup"||k==="dropoff")?"span 2":"auto" }}>
                      <label style={{ display:"block", fontSize:11, fontWeight:600, color:"#6B87B0", letterSpacing:.8, marginBottom:4 }}>{l.toUpperCase()}</label>
                      <input type={t||"text"} value={form[k]||""} onChange={e=>setForm(f=>({...f,[k]:e.target.value}))}
                        style={{ width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"9px 12px", fontSize:13, outline:"none", background:"#F9FBFF" }}/>
                    </div>
                  ))}
                  <div>
                    <label style={{ display:"block", fontSize:11, fontWeight:600, color:"#6B87B0", letterSpacing:.8, marginBottom:4 }}>DRIVER</label>
                    <select value={form.driver||""} onChange={e=>setForm(f=>({...f,driver:e.target.value}))}
                      style={{ width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"9px 12px", fontSize:13, background:"#F9FBFF", outline:"none" }}>
                      {DRIVERS.map(d=><option key={d}>{d}</option>)}
                    </select>
                  </div>
                  <div>
                    <label style={{ display:"block", fontSize:11, fontWeight:600, color:"#6B87B0", letterSpacing:.8, marginBottom:4 }}>STATUS</label>
                    <select value={form.status||""} onChange={e=>setForm(f=>({...f,status:e.target.value}))}
                      style={{ width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"9px 12px", fontSize:13, background:"#F9FBFF", outline:"none" }}>
                      {STATUS_OPTIONS.map(s=><option key={s}>{s}</option>)}
                    </select>
                  </div>
                  {[{k:"fare",l:"Fare ($)"},{k:"charge",l:"Charge ($)"},{k:"tip",l:"Tip ($)"}].map(({k,l})=>(
                    <div key={k}>
                      <label style={{ display:"block", fontSize:11, fontWeight:600, color:"#6B87B0", letterSpacing:.8, marginBottom:4 }}>{l.toUpperCase()}</label>
                      <input type="number" step="0.01" min="0" value={form[k]||""} onChange={e=>setForm(f=>({...f,[k]:e.target.value}))}
                        style={{ width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"9px 12px", fontSize:13, background:"#F9FBFF", outline:"none" }}/>
                    </div>
                  ))}
                </>
              )}
            </div>
            <div style={{ padding:"12px 24px 18px", display:"flex", gap:10 }}>
              <button onClick={()=>setShowModal(false)} style={{ flex:1, background:"#F0F4FB", color:"#6B87B0", borderRadius:8, padding:"10px", fontSize:13, fontWeight:600, fontFamily:"'Oswald',sans-serif" }}>CANCEL</button>
              <button onClick={handleSave} style={{ flex:2, background:"linear-gradient(135deg,#0A1628,#1E4D8C)", color:"#fff", borderRadius:8, padding:"10px", fontSize:13, fontWeight:600, fontFamily:"'Oswald',sans-serif", letterSpacing:.8 }}>
                {editRide?"SAVE CHANGES":"BOOK RIDE"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ DELETE CONFIRM â”€â”€ */}
      {deleteConfirm && (
        <div className="modal-overlay" onClick={()=>setDeleteConfirm(null)}
          style={{ position:"fixed", inset:0, background:"rgba(10,22,40,.6)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000, padding:20 }}>
          <div className="modal-box" onClick={e=>e.stopPropagation()}
            style={{ background:"#fff", borderRadius:14, width:"100%", maxWidth:360, padding:"24px", textAlign:"center", boxShadow:"0 20px 60px rgba(10,22,40,.35)" }}>
            <div style={{ fontSize:32, marginBottom:10 }}>ðŸ—‘</div>
            <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:18, fontWeight:700, color:"#0A1628", marginBottom:6 }}>DELETE RIDE?</div>
            <div style={{ fontSize:13, color:"#6B87B0", marginBottom:20 }}>This will permanently remove the ride and sync the change to Google Sheets.</div>
            <div style={{ display:"flex", gap:10 }}>
              <button onClick={()=>setDeleteConfirm(null)} style={{ flex:1, background:"#F0F4FB", color:"#6B87B0", borderRadius:8, padding:"10px", fontSize:13, fontWeight:600, fontFamily:"'Oswald',sans-serif" }}>CANCEL</button>
              <button onClick={()=>handleDelete(deleteConfirm)} style={{ flex:1, background:"#991B1B", color:"#fff", borderRadius:8, padding:"10px", fontSize:13, fontWeight:600, fontFamily:"'Oswald',sans-serif" }}>DELETE</button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ VOICE CONFIRM â”€â”€ */}
      {voicePickup && (
        <div className="modal-overlay"
          style={{ position:"fixed", inset:0, background:"rgba(10,22,40,.75)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000, padding:20 }}>
          <div className="modal-box"
            style={{ background:"#fff", borderRadius:16, width:"100%", maxWidth:440, padding:"24px", boxShadow:"0 20px 60px rgba(10,22,40,.4)" }}>
            <div style={{ fontFamily:"'Oswald',sans-serif", fontSize:16, fontWeight:700, color:"#0A1628", letterSpacing:1, marginBottom:14 }}>ðŸŽ¤ HEARD THIS PICKUP?</div>
            <div style={{ background:"#F0F6FF", borderRadius:10, padding:"12px 16px", fontSize:14, color:"#0A1628", fontWeight:600, marginBottom:8 }}>"{voicePickup.text}"</div>
            <div style={{ fontSize:11, color:"#9FB4D0", marginBottom:18 }}>ðŸ“… {voicePickup.date} Â· â° {voicePickup.time} Â· Status: Scheduled</div>
            <div style={{ display:"flex", gap:10 }}>
              <button onClick={()=>setVoicePickup(null)} style={{ flex:1, background:"#F0F4FB", color:"#6B87B0", borderRadius:8, padding:"9px", fontSize:12, fontWeight:600, fontFamily:"'Oswald',sans-serif" }}>RETRY</button>
              <button onClick={()=>{setVoicePickup(null);openEdit({...EMPTY_FORM,pickup:voicePickup.text,date:voicePickup.date,time:voicePickup.time,status:"Scheduled",id:genId()});}}
                style={{ flex:1, background:"#EBF2FF", color:"#1E4D8C", borderRadius:8, padding:"9px", fontSize:12, fontWeight:600, fontFamily:"'Oswald',sans-serif" }}>EDIT</button>
              <button onClick={confirmVoiceRide}
                style={{ flex:1, background:"linear-gradient(135deg,#0A1628,#1E4D8C)", color:"#fff", borderRadius:8, padding:"9px", fontSize:12, fontWeight:600, fontFamily:"'Oswald',sans-serif" }}>CONFIRM</button>
            </div>
          </div>
        </div>
      )}

      {/* â”€â”€ TOAST â”€â”€ */}
      {toast && (
        <div style={{ position:"fixed", bottom:24, right:16, background:"#0A1628", color:"#fff", padding:"10px 18px", borderRadius:10, fontSize:13, fontWeight:600, boxShadow:"0 4px 20px rgba(10,22,40,.4)", animation:"toastIn .3s ease", zIndex:2000, maxWidth:280 }}>
          {toast}
        </div>
      )}
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>

<script>
  // Register service worker for offline support
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.log('SW failed:', err));
    });
  }
</script>
</body>
</html>
