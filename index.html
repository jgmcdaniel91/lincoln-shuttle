<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0A1628">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lincoln Shuttle">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <title>Lincoln Shuttle Dispatch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body { font-family: 'Source Sans 3', sans-serif; background: #EEF2F9; color: #2D3A52; font-size: 16px; padding-right: env(safe-area-inset-right); }
    select { border: none; outline: none; }
    button { border: none; outline: none; cursor: pointer; background: none; font-family: inherit; -webkit-appearance: none; }
    input, select, textarea { font-family: inherit; font-size: 16px; }
    @keyframes toastIn  { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes spin     { to { transform: rotate(360deg); } }
    .sync-spin { display: inline-block; animation: spin 1s linear infinite; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #EEF2F9; }
    ::-webkit-scrollbar-thumb { background: #B0C4DE; border-radius: 3px; }
  </style>
</head>
<body>
<div id="root"></div>

<!-- â•â•â• Storage Module â•â•â• -->
<script>
const LS = {
  SCRIPT_KEY: 'ls-script-url',
  RIDES_KEY:  'ls-rides-cache',
  DRIVERS_KEY:'ls-drivers',
  PENDING_KEY:'ls-pending-sync',

  getUrl()       { return localStorage.getItem(this.SCRIPT_KEY) || 'https://script.google.com/macros/s/AKfycbyirUHBboMV2t6svhFvgqhT0QTdVnswOyrJqjgx2luZD6WbXPW-1SOVnoBrwI6cVMC8/exec'; },
  setUrl(url)    { localStorage.setItem(this.SCRIPT_KEY, url.trim()); },
  getCached()    { try { const s = localStorage.getItem(this.RIDES_KEY); return s ? JSON.parse(s) : null; } catch { return null; } },
  setCached(r)   { localStorage.setItem(this.RIDES_KEY, JSON.stringify(r)); },
  getDrivers()   { try { const s = localStorage.getItem(this.DRIVERS_KEY); return s ? JSON.parse(s) : null; } catch { return null; } },
  setDrivers(d)  { localStorage.setItem(this.DRIVERS_KEY, JSON.stringify(d)); },
  hasPending()   { return localStorage.getItem(this.PENDING_KEY) === 'true'; },
  setPending(v)  { v ? localStorage.setItem(this.PENDING_KEY,'true') : localStorage.removeItem(this.PENDING_KEY); },

  async fetchRides(onStatus) {
    const url = this.getUrl();
    if (!url) { onStatus('no-config'); return this.getCached(); }
    onStatus('syncing');
    try {
      const res = await fetch(url + '?action=getRides&t=' + Date.now());
      const data = await res.json();
      const rides = data.rides || [];
      this.setCached(rides);
      this.setPending(false);
      onStatus('synced');
      return rides;
    } catch {
      onStatus(navigator.onLine ? 'error' : 'offline');
      return this.getCached();
    }
  },

  async saveRides(rides, onStatus) {
    this.setCached(rides);
    const url = this.getUrl();
    if (!url) { onStatus('no-config'); return; }
    onStatus('syncing');
    try {
      await fetch(url, {
        method: 'POST',
        body: JSON.stringify({ action: 'saveRides', rides })
      });
      this.setPending(false);
      onStatus('synced');
    } catch {
      this.setPending(true);
      onStatus(navigator.onLine ? 'error' : 'offline');
    }
  }
};
</script>

<!-- â•â•â• React App â•â•â• -->
<script type="text/babel">
const { useState, useEffect } = React;

const INITIAL_DRIVERS = { active: ["Jeremy","Reggie","Gene","Eric"], archived: [] };
const STATUS_OPTIONS = ["Scheduled","In Progress","Completed","Cancelled"];
const STATUS_STYLES = {
  "Scheduled":   { bg:"#EBF2FF", color:"#1E4D8C", border:"#93B8F0" },
  "In Progress": { bg:"#FFF8E6", color:"#B45309", border:"#FCD34D" },
  "Completed":   { bg:"#EDFAF3", color:"#065F46", border:"#6EE7B7" },
  "Cancelled":   { bg:"#FEF2F2", color:"#991B1B", border:"#FCA5A5" },
};
const EMPTY_FORM = { driver:"", date:"", time:"", pickup:"", dropoff:"", fare:"", charge:"", tip:"", status:"Scheduled", details:"" };
const toDateStr = d => d.toISOString().slice(0,10);

const SAMPLE_RIDES = [
  { id:"LS-SUN1",   driver:"Jeremy",  date:"2026-02-15", time:"07:00", pickup:"Bangor International Airport",   dropoff:"Holiday Inn, Main St",         fare:"45.00", charge:"45.00",  tip:"9.00",  status:"Completed",  details:"" },
  { id:"LS-SUN2",   driver:"Reggie",  date:"2026-02-15", time:"09:30", pickup:"Hampton Inn, Hogan Rd",          dropoff:"Bar Harbor, ME",               fare:"95.00", charge:"100.00", tip:"20.00", status:"Completed",  details:"" },
  { id:"LS-MON1",   driver:"Gene",    date:"2026-02-16", time:"08:00", pickup:"321 Union St, Bangor",           dropoff:"Eastern Maine Medical Center",  fare:"22.00", charge:"22.00",  tip:"4.00",  status:"Completed",  details:"" },
  { id:"LS-MON2",   driver:"Eric",    date:"2026-02-16", time:"11:15", pickup:"University of Maine, Orono",     dropoff:"Bangor Mall",                   fare:"28.00", charge:"30.00",  tip:"5.00",  status:"Completed",  details:"" },
  { id:"LS-TUE1",   driver:"Jeremy",  date:"2026-02-17", time:"06:30", pickup:"Cross Insurance Arena",          dropoff:"Bangor International Airport",  fare:"38.00", charge:"38.00",  tip:"8.00",  status:"Completed",  details:"" },
  { id:"LS-TUE2",   driver:"Reggie",  date:"2026-02-17", time:"14:00", pickup:"Bangor Mall",                    dropoff:"Brewer, ME",                    fare:"18.00", charge:"20.00",  tip:"3.00",  status:"Completed",  details:"" },
  { id:"LS-WED1",   driver:"Gene",    date:"2026-02-18", time:"09:00", pickup:"Eastern Maine Medical Center",   dropoff:"Hampden, ME",                   fare:"32.00", charge:"32.00",  tip:"6.00",  status:"Completed",  details:"" },
  { id:"LS-WED2",   driver:"Eric",    date:"2026-02-18", time:"13:30", pickup:"Bangor International Airport",   dropoff:"Ellsworth, ME",                 fare:"55.00", charge:"60.00",  tip:"12.00", status:"Completed",  details:"" },
  { id:"LS-THU1",   driver:"Jeremy",  date:"2026-02-19", time:"07:45", pickup:"Holiday Inn, Main St",           dropoff:"Augusta, ME",                   fare:"75.00", charge:"80.00",  tip:"15.00", status:"Completed",  details:"" },
  { id:"LS-THU2",   driver:"Reggie",  date:"2026-02-19", time:"15:00", pickup:"Brewer, ME",                     dropoff:"Bangor International Airport",  fare:"20.00", charge:"20.00",  tip:"4.00",  status:"Completed",  details:"" },
  { id:"LS-FRI1",   driver:"Gene",    date:"2026-02-20", time:"08:30", pickup:"University of Maine, Orono",     dropoff:"Bar Harbor, ME",                fare:"90.00", charge:"95.00",  tip:"18.00", status:"Scheduled",  details:"" },
  { id:"LS-FRI2",   driver:"Eric",    date:"2026-02-20", time:"12:00", pickup:"321 Union St, Bangor",           dropoff:"Rockland, ME",                  fare:"65.00", charge:"65.00",  tip:"10.00", status:"Scheduled",  details:"" },
  { id:"LS-SAT1",   driver:"Jeremy",  date:"2026-02-21", time:"10:00", pickup:"Bangor International Airport",   dropoff:"Camden, ME",                    fare:"80.00", charge:"85.00",  tip:"17.00", status:"Scheduled",  details:"" },
  { id:"LS-SAT2",   driver:"Reggie",  date:"2026-02-21", time:"16:30", pickup:"Cross Insurance Arena",          dropoff:"Waterville, ME",                fare:"50.00", charge:"50.00",  tip:"10.00", status:"Scheduled",  details:"" },
  { id:"LS-P-SUN1", driver:"Gene",    date:"2026-02-08", time:"08:00", pickup:"Bangor Mall",                    dropoff:"Bangor International Airport",  fare:"20.00", charge:"20.00",  tip:"4.00",  status:"Completed",  details:"" },
  { id:"LS-P-SUN2", driver:"Eric",    date:"2026-02-08", time:"11:00", pickup:"Hampton Inn, Hogan Rd",          dropoff:"Bar Harbor, ME",                fare:"95.00", charge:"100.00", tip:"20.00", status:"Completed",  details:"" },
];

function genId() { return "LS-" + Date.now().toString(36).toUpperCase(); }
function getShiftDate(now = new Date()) { const d = new Date(now); if (d.getHours() < 3) d.setDate(d.getDate()-1); return d; }

function SyncBadge({ status }) {
  const map = {
    synced:    { dot:"#6EE7B7", label:"Synced",     spin:false },
    syncing:   { dot:"#93B8F0", label:"Syncingâ€¦",   spin:true  },
    offline:   { dot:"#FCD34D", label:"Offline",    spin:false },
    error:     { dot:"#FCA5A5", label:"Sync error", spin:false },
    'no-config':{ dot:"#9CA3AF",label:"Not set up", spin:false },
    loading:   { dot:"#93B8F0", label:"Loadingâ€¦",   spin:true  },
  };
  const s = map[status] || map['no-config'];
  return (
    <div style={{ display:"flex", alignItems:"center", gap:4, fontSize:9, color:"rgba(255,255,255,0.7)", fontFamily:"'Source Sans 3', sans-serif" }}>
      <span className={s.spin ? "sync-spin" : ""} style={{ display:"inline-block", width:7, height:7, borderRadius:"50%", background: s.dot }}></span>
      {s.label}
    </div>
  );
}

function App() {
  const [rides,         setRides]         = useState([]);
  const [drivers,       setDrivers]       = useState(INITIAL_DRIVERS);
  const [loading,       setLoading]       = useState(true);
  const [syncStatus,    setSyncStatus]    = useState('loading');
  const [showDriverModal, setShowDriverModal] = useState(false);
  const [newDriverName, setNewDriverName] = useState("");
  const [showModal,     setShowModal]     = useState(false);
  const [showFullForm,  setShowFullForm]  = useState(false);
  const [editRide,      setEditRide]      = useState(null);
  const [form,          setForm]          = useState(EMPTY_FORM);
  const [filterStatus,  setFilterStatus]  = useState("All");
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [toast,         setToast]         = useState(null);
  const [listening,     setListening]     = useState(false);
  const [voicePickup,   setVoicePickup]   = useState(null);
  const recognitionRef = { current: null };
  const [checkedRides,  setCheckedRides]  = useState({});
  const [showSettings,  setShowSettings]  = useState(false);
  const [settingsUrl,   setSettingsUrl]   = useState('');
  const [settingsTesting, setSettingsTesting] = useState(false);
  const [statsDriver,   setStatsDriver]   = useState(INITIAL_DRIVERS.active[0]);
  const [rollingDriver, setRollingDriver] = useState(INITIAL_DRIVERS.active[0]);
  const [rollingOpen,   setRollingOpen]   = useState(false);
  const [openDays,      setOpenDays]      = useState(() => ({ [toDateStr(getShiftDate())]: true }));
  const [prevSectionOpen,   setPrevSectionOpen]   = useState(false);
  const [prevStatsDriver,   setPrevStatsDriver]   = useState(INITIAL_DRIVERS.active[0]);
  const [prevRollingDriver, setPrevRollingDriver] = useState(INITIAL_DRIVERS.active[0]);
  const [prevRollingOpen,   setPrevRollingOpen]   = useState(false);
  const [prevOpenDays,      setPrevOpenDays]      = useState({});
  const [selectedWeekSunStr, setSelectedWeekSunStr] = useState(() => {
    const d = getShiftDate(); const sun = new Date(d); sun.setDate(d.getDate() - d.getDay() - 7);
    return toDateStr(sun);
  });

  useEffect(() => {
    const isPreview = location.hostname.includes('claudeusercontent.com') || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if ('serviceWorker' in navigator && !isPreview) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
    LS.fetchRides(setSyncStatus).then(fetched => {
      if (fetched && fetched.length > 0) setRides(fetched);
      else { setRides(SAMPLE_RIDES); LS.setCached(SAMPLE_RIDES); }
      setLoading(false);
    });
    const savedDrivers = LS.getDrivers();
    if (savedDrivers) setDrivers(savedDrivers);
    setSettingsUrl(LS.getUrl());

    const handleOnline = () => {
      if (LS.hasPending()) {
        const cached = LS.getCached();
        if (cached) LS.saveRides(cached, setSyncStatus);
      }
    };
    window.addEventListener('online', handleOnline);
    return () => window.removeEventListener('online', handleOnline);
  }, []);

  async function saveRides(updated) {
    setRides(updated);
    await LS.saveRides(updated, setSyncStatus);
  }

  async function saveDrivers(updated) {
    setDrivers(updated);
    LS.setDrivers(updated);
  }

  function showToast(msg) { setToast(msg); setTimeout(() => setToast(null), 2800); }
  function toggleCheck(id) { setCheckedRides(p => ({ ...p, [id]: !p[id] })); }
  function toggleDay(ds)     { setOpenDays(p => ({ ...p, [ds]: !p[ds] })); }
  function togglePrevDay(ds) { setPrevOpenDays(p => ({ ...p, [ds]: !p[ds] })); }

  function openNew() {
    const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
    setEditRide(null); setShowFullForm(false);
    setForm({ ...EMPTY_FORM, date: toDateStr(getShiftDate(now)), time: `${hh}:${mm}` });
    setShowModal(true);
  }
  function openEdit(ride) { setEditRide(ride.id); setForm({ ...ride }); setShowModal(true); }

  async function handleSave() {
    if (!editRide && !form.pickup) return;
    if (editRide && (!form.date || !form.time || !form.pickup)) return;
    if (editRide) {
      await saveRides(rides.map(r => r.id === editRide ? { ...form, id: editRide } : r));
      showToast("Ride updated.");
    } else {
      await saveRides([{ ...form, id: genId() }, ...rides]);
      showToast("Ride booked.");
    }
    setShowModal(false);
  }

  async function handleDelete(id) {
    await saveRides(rides.filter(r => r.id !== id));
    setDeleteConfirm(null);
    showToast("Ride removed.");
  }

  function startVoice() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { showToast("Voice not supported â€” use Chrome."); return; }
    if (listening) return;
    const rec = new SR(); rec.lang = "en-US"; rec.interimResults = false; rec.maxAlternatives = 1;
    recognitionRef.current = rec; setListening(true);
    rec.onresult = e => {
      const text = e.results[0][0].transcript; const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      setVoicePickup({ text, date: toDateStr(getShiftDate(now)), time: `${hh}:${mm}` });
      setListening(false);
    };
    rec.onerror = () => { setListening(false); showToast("Couldn't hear that â€” try again."); };
    rec.onend   = () => setListening(false);
    rec.start();
  }

  async function confirmVoiceRide() {
    if (!voicePickup) return;
    await saveRides([{ ...EMPTY_FORM, id: genId(), pickup: voicePickup.text, date: voicePickup.date, time: voicePickup.time, status: "Scheduled" }, ...rides]);
    setVoicePickup(null);
    showToast("Ride booked â€” " + voicePickup.text);
  }

  function addDriver() {
    const name = newDriverName.trim();
    if (!name) return;
    if (drivers.active.includes(name) || drivers.archived.includes(name)) { showToast("Driver already exists"); return; }
    const updated = { ...drivers, active: [...drivers.active, name] };
    saveDrivers(updated);
    setNewDriverName("");
    showToast("Driver added: " + name);
  }

  function archiveDriver(name) {
    const updated = { active: drivers.active.filter(n => n !== name), archived: [...drivers.archived, name] };
    saveDrivers(updated);
    showToast("Driver archived: " + name);
  }

  function unarchiveDriver(name) {
    const updated = { active: [...drivers.active, name], archived: drivers.archived.filter(n => n !== name) };
    saveDrivers(updated);
    showToast("Driver restored: " + name);
  }

  async function handleSettingsSave() {
    LS.setUrl(settingsUrl);
    setShowSettings(false);
    setSyncStatus('syncing');
    const fetched = await LS.fetchRides(setSyncStatus);
    if (fetched && fetched.length > 0) { setRides(fetched); showToast("Connected & synced!"); }
    else showToast("Saved â€” no rides in sheet yet.");
  }

  async function handleSettingsTest() {
    if (!settingsUrl.trim()) { showToast("Enter your Apps Script URL first."); return; }
    setSettingsTesting(true);
    try {
      const res = await fetch(settingsUrl.trim() + '?action=getRides&t=' + Date.now());
      const data = await res.json();
      showToast(`âœ“ Connected! ${(data.rides||[]).length} rides in sheet.`);
    } catch {
      showToast("âœ— Connection failed â€” check the URL.");
    }
    setSettingsTesting(false);
  }

  const shiftNow   = getShiftDate();
  const weekSunday = new Date(shiftNow); weekSunday.setDate(shiftNow.getDate() - shiftNow.getDay());
  const weekSat    = new Date(weekSunday); weekSat.setDate(weekSunday.getDate() + 6);
  const weekStart  = toDateStr(weekSunday), weekEnd = toDateStr(weekSat);
  const weekLabel  = weekSunday.toLocaleDateString("en-US",{month:"short",day:"numeric"}) + " â€“ " + weekSat.toLocaleDateString("en-US",{month:"short",day:"numeric"});

  const weekRides   = rides.filter(r => r.date >= weekStart && r.date <= weekEnd && r.driver === statsDriver);
  const weekFare    = weekRides.reduce((a,r) => a+(parseFloat(r.fare)||0), 0);
  const weekCharge  = weekRides.reduce((a,r) => a+(parseFloat(r.charge)||0), 0);
  const weekTip     = weekRides.reduce((a,r) => a+(parseFloat(r.tip)||0), 0);

  const weekDays = Array.from({length:7},(_,i)=>{ const d=new Date(weekSunday); d.setDate(weekSunday.getDate()+i); return { dateStr:toDateStr(d), label:d.toLocaleDateString("en-US",{weekday:"long"}), short:d.toLocaleDateString("en-US",{month:"short",day:"numeric"}), isToday:toDateStr(d)===toDateStr(getShiftDate()) }; });

  const selectedSun = new Date(selectedWeekSunStr+"T12:00:00");
  const selectedSat = new Date(selectedSun); selectedSat.setDate(selectedSun.getDate()+6);
  const prevStart   = toDateStr(selectedSun), prevEnd = toDateStr(selectedSat);
  const prevLabel   = selectedSun.toLocaleDateString("en-US",{month:"short",day:"numeric"}) + " â€“ " + selectedSat.toLocaleDateString("en-US",{month:"short",day:"numeric"});

  const prevWeekRides  = rides.filter(r => r.date>=prevStart && r.date<=prevEnd && r.driver===prevStatsDriver);
  const prevWeekFare   = prevWeekRides.reduce((a,r)=>a+(parseFloat(r.fare)||0),0);
  const prevWeekCharge = prevWeekRides.reduce((a,r)=>a+(parseFloat(r.charge)||0),0);
  const prevWeekTip    = prevWeekRides.reduce((a,r)=>a+(parseFloat(r.tip)||0),0);

  const prevDays = Array.from({length:7},(_,i)=>{ const d=new Date(selectedSun); d.setDate(selectedSun.getDate()+i); return { dateStr:toDateStr(d), label:d.toLocaleDateString("en-US",{weekday:"long"}), short:d.toLocaleDateString("en-US",{month:"short",day:"numeric"}), isToday:false }; });

  const allWeeks = (() => {
    const weeks=[]; const start=new Date("2026-01-04T12:00:00"); const curr=new Date(weekSunday); curr.setHours(12,0,0,0); const d=new Date(start);
    while(d<curr){ const sat=new Date(d); sat.setDate(d.getDate()+6); weeks.push({ sunStr:toDateStr(d), label:d.toLocaleDateString("en-US",{month:"short",day:"numeric"})+" â€“ "+sat.toLocaleDateString("en-US",{month:"short",day:"numeric"}) }); d.setDate(d.getDate()+7); }
    return weeks.reverse();
  })();

  const filtered = rides.filter(r => filterStatus==="All"||r.status===filterStatus)
    .sort((a,b)=>((b.date||"")+(b.time||"")).localeCompare((a.date||"")+(a.time||"")));

  function DriverSelect({ value, onChange, light }) {
    return (
      <div style={{position:"relative",display:"inline-flex",alignItems:"center",maxWidth:"140px"}}>
        <select value={value} onChange={e=>onChange(e.target.value)}
          style={{border:light?"none":"1.5px solid #D1DEFA",borderRadius:6,padding:"4px 24px 4px 8px",fontSize:11,color:value?"#0A1628":"#9FB4D0",fontFamily:"system-ui,sans-serif",cursor:"pointer",background:light?"#fff":"#F5F8FF",appearance:"none",width:"100%",minWidth:0}}>
          <option value="">Unassigned</option>
          {drivers.active.map(d=><option key={d}>{d}</option>)}
        </select>
        <span style={{position:"absolute",right:6,pointerEvents:"none",fontSize:9,color:"#1E4D8C"}}>â–¼</span>
      </div>
    );
  }

  function RideRow({ ride, i }) {
    const n = parseFloat(ride.fare);
    const fareStr = isNaN(n) ? "" : "$"+(n%1===0?n.toFixed(0):n.toFixed(2));
    return (
      <tr style={{background:i%2===0?"#fff":"#F8FAFF",borderBottom:"1px solid #EBF0FA",cursor:"pointer"}}
        onClick={()=>openEdit(ride)}
        onMouseEnter={e=>e.currentTarget.style.background="#F0F6FF"}
        onMouseLeave={e=>e.currentTarget.style.background=i%2===0?"#fff":"#F8FAFF"}>
        <td style={{padding:"10px 16px 10px 12px",width:"100%"}}>
          <div style={{display:"flex",alignItems:"flex-start",gap:10}}>
            <input type="checkbox" checked={!!checkedRides[ride.id]} onChange={e=>{e.stopPropagation();toggleCheck(ride.id);}}
              style={{accentColor:"#1E4D8C",width:18,height:18,cursor:"pointer",flexShrink:0,marginTop:2}}/>
            <div style={{flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:4}}>
              <div style={{fontWeight:700,fontSize:13,color:"#2D3A52"}}>{ride.driver || <span style={{color:"#C0CCDE",fontStyle:"italic",fontWeight:400}}>Unassigned</span>}</div>
              <div style={{fontSize:13,color:"#2D3A52",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                {ride.pickup||"â€”"}
                {ride.dropoff?<span style={{color:"#6B87B0"}}> to </span>:""}
                {ride.dropoff||""}
              </div>
              {(ride.fare||ride.charge)&&(
                <div style={{fontSize:13,fontWeight:700,color:"#0A1628"}}>
                  {ride.fare&&<span>{fareStr}</span>}
                  {ride.charge&&<span> Charge ${parseFloat(ride.charge).toFixed(2)}</span>}
                </div>
              )}
            </div>
            <button onClick={e=>{e.stopPropagation();setDeleteConfirm(ride.id);}} style={{background:"#FEF2F2",color:"#991B1B",border:"none",borderRadius:6,padding:"6px 8px",fontSize:10,fontWeight:600,flexShrink:0,whiteSpace:"nowrap",minHeight:32}}>Del</button>
          </div>
        </td>
      </tr>
    );
  }

  function DaySection({ day, dayRides, isOpen, onToggle }) {
    return (
      <div style={{background:"#fff",borderRadius:10,boxShadow:"0 1px 6px rgba(30,77,140,.08)",overflow:"hidden",border:day.isToday?"2px solid #1E4D8C":"2px solid transparent"}}>
        <div style={{background:day.isToday?"linear-gradient(135deg,#0A1628,#1E4D8C)":"linear-gradient(135deg,#2D3A52,#4A6A9C)",padding:"10px 12px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",minHeight:44}}
          onClick={onToggle}>
          <div style={{display:"flex",alignItems:"center",gap:6,flex:1,minWidth:0,overflow:"hidden"}}>
            <span style={{fontFamily:"system-ui,sans-serif",fontWeight:700,fontSize:12,color:"#fff",letterSpacing:.5,flexShrink:0}}>{day.label.toUpperCase()}</span>
            <span style={{fontSize:10,color:"rgba(255,255,255,.65)",flexShrink:0}}>{day.short}</span>
            {day.isToday&&<span style={{background:"rgba(255,255,255,.25)",color:"#fff",fontSize:8,fontWeight:700,padding:"2px 6px",borderRadius:8,letterSpacing:.3,flexShrink:0}}>TODAY</span>}
          </div>
          <span style={{fontSize:11,color:"rgba(255,255,255,.7)",fontWeight:600,flexShrink:0,marginLeft:8}}>{dayRides.length} ride{dayRides.length!==1?"s":""}</span>
        </div>
        {isOpen&&(dayRides.length===0?(
          <div style={{padding:"12px 14px",fontSize:13,color:"#C0CCDE",fontStyle:"italic"}}>No rides scheduled</div>
        ):(
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:14,tableLayout:"fixed"}}>
            <tbody>{dayRides.map((r,i)=><RideRow key={r.id} ride={r} i={i}/>)}</tbody>
          </table>
        ))}
      </div>
    );
  }

  function RollingTable({ days, driver }) {
    let running = 0;
    return (
      <table style={{width:"100%",borderCollapse:"collapse",fontSize:11.5}}>
        <thead><tr style={{background:"#F0F4FB"}}>
          {["Day","Day Fares","Running Total"].map(h=>(
            <th key={h} style={{padding:"5px 12px",textAlign:h==="Day"?"left":"right",fontFamily:"system-ui,sans-serif",fontSize:10,fontWeight:600,color:"#6B87B0",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
          ))}
        </tr></thead>
        <tbody>
          {days.map((day,i)=>{
            const df=rides.filter(r=>r.date===day.dateStr&&r.driver===driver).reduce((a,r)=>a+(parseFloat(r.fare)||0),0);
            running+=df; const has=df>0;
            return(
              <tr key={day.dateStr} style={{borderBottom:"1px solid #EBF0FA",background:day.isToday?"#EBF2FF":i%2===0?"#fff":"#F8FAFF"}}>
                <td style={{padding:"5px 12px",color:day.isToday?"#1E4D8C":"#2D3A52",fontWeight:day.isToday?700:400}}>
                  {day.label} <span style={{color:"#9FB4D0",fontSize:10}}>{day.short}</span>
                  {day.isToday&&<span style={{marginLeft:6,background:"#1E4D8C",color:"#fff",fontSize:8,fontWeight:700,padding:"1px 5px",borderRadius:8}}>TODAY</span>}
                </td>
                <td style={{padding:"5px 12px",textAlign:"right",color:has?"#0A1628":"#C0CCDE",fontWeight:has?600:400}}>{has?"$"+df.toFixed(2):"â€”"}</td>
                <td style={{padding:"5px 12px",textAlign:"right",fontWeight:700,fontSize:13,color:running>0?"#065F46":"#C0CCDE"}}>{running>0?"$"+running.toFixed(2):"â€”"}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    );
  }

  const inputStyle = { width:"100%", border:"1.5px solid #D1DEFA", borderRadius:8, padding:"12px 14px", fontSize:16, background:"#F9FBFF", outline:"none", fontFamily:"system-ui,sans-serif" };
  const labelStyle = { display:"block", fontSize:12, fontWeight:600, color:"#6B87B0", letterSpacing:.5, marginBottom:6, textTransform:"uppercase" };

  if (loading) return (
    <div style={{background:"#EEF2F9",minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div style={{fontFamily:"system-ui,sans-serif",fontSize:24,color:"#1E4D8C",letterSpacing:2}}>LOADINGâ€¦</div>
    </div>
  );

  return (
    <>
      <style>{`
        @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }
        .modal-overlay { animation:fadeIn .15s ease; }
        .modal-box     { animation:slideUp .2s ease; }
      `}</style>

      <div style={{minHeight:"100vh",background:"#EEF2F9",fontFamily:"system-ui,sans-serif",color:"#2D3A52",overflowX:"hidden"}}>

        {/* HEADER */}
        <div style={{background:"linear-gradient(135deg,#0A1628,#1E4D8C)",padding:"8px 12px",display:"flex",alignItems:"center",justifyContent:"space-between",minHeight:56,boxShadow:"0 2px 12px rgba(10,22,40,.35)",position:"sticky",top:0,zIndex:100}}>
          <div style={{display:"flex",alignItems:"center",gap:8,minWidth:0,flex:1}}>
            <div style={{background:"#fff",borderRadius:6,width:32,height:32,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M3 17h2a2 2 0 004 0h6a2 2 0 004 0h2V9l-3-5H6L3 9v8z" fill="#1E4D8C"/>
                <circle cx="7" cy="17" r="1.5" fill="white"/><circle cx="17" cy="17" r="1.5" fill="white"/>
                <path d="M3 13h18" stroke="white" strokeWidth="1.2"/>
              </svg>
            </div>
            <div style={{minWidth:0,overflow:"hidden"}}>
              <div style={{fontSize:13,fontWeight:700,color:"#fff",letterSpacing:1.5,lineHeight:1,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>LINCOLN SHUTTLE</div>
              <div style={{fontSize:8,color:"#93B8F0",letterSpacing:1,marginTop:2}}>DISPATCH</div>
            </div>
          </div>

          <div style={{display:"flex",alignItems:"center",gap:6,flexShrink:0}}>
            <button onClick={()=>setShowDriverModal(true)}
              style={{background:"rgba(255,255,255,.15)",color:"#fff",border:"1px solid rgba(255,255,255,.3)",borderRadius:8,padding:"8px 12px",fontWeight:600,fontSize:12,letterSpacing:.5,minHeight:36}}>
              DRIVERS
            </button>
            <button onClick={startVoice}
              style={{width:42,height:42,borderRadius:"50%",border:"none",
                background:listening?"#E53E3E":"#fff",
                boxShadow:listening?"0 0 0 3px rgba(229,62,62,.4)":"0 2px 8px rgba(255,255,255,.25)",
                display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <rect x="9" y="2" width="6" height="12" rx="3" fill={listening?"#fff":"#0A1628"}/>
                <path d="M5 11a7 7 0 0014 0" stroke={listening?"#fff":"#0A1628"} strokeWidth="2" strokeLinecap="round"/>
                <line x1="12" y1="18" x2="12" y2="22" stroke={listening?"#fff":"#0A1628"} strokeWidth="2" strokeLinecap="round"/>
                <line x1="8" y1="22" x2="16" y2="22" stroke={listening?"#fff":"#0A1628"} strokeWidth="2" strokeLinecap="round"/>
              </svg>
            </button>
            <button onClick={openNew}
              style={{background:"rgba(255,255,255,.15)",color:"#fff",border:"1px solid rgba(255,255,255,.3)",borderRadius:8,padding:"8px 12px",fontWeight:600,fontSize:12,letterSpacing:.5,minHeight:36}}>
              MANUAL
            </button>
          </div>
        </div>

        <div style={{padding:"10px 12px 10px 10px",maxWidth:1200,margin:"0 auto"}}>

          {/* STATS */}
          <div style={{marginBottom:12}}>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,flexWrap:"wrap"}}>
              <div style={{fontSize:10,fontWeight:700,color:"#6B87B0",letterSpacing:.8,lineHeight:1.3}}>WEEK Â· {weekLabel}</div>
              <DriverSelect value={statsDriver} onChange={setStatsDriver}/>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:12}}>
              {[{label:"Fares",value:"$"+weekFare.toFixed(2),icon:"ðŸ§¾"},{label:"Charges",value:"$"+weekCharge.toFixed(2),icon:"ðŸ’³"},{label:"Tips",value:"$"+weekTip.toFixed(2),icon:"ðŸ’°"}].map(s=>(
                <div key={s.label} style={{background:"#fff",borderRadius:10,padding:"10px 8px",boxShadow:"0 1px 4px rgba(30,77,140,.08)",borderTop:"3px solid #1E4D8C",minWidth:0}}>
                  <div style={{display:"flex",flexDirection:"column",alignItems:"center",textAlign:"center"}}>
                    <span style={{fontSize:18,marginBottom:4}}>{s.icon}</span>
                    <div style={{fontSize:9,fontWeight:600,color:"#6B87B0",letterSpacing:.5,textTransform:"uppercase",marginBottom:4}}>{s.label}</div>
                    <div style={{fontSize:18,fontWeight:700,color:"#0A1628",lineHeight:1,whiteSpace:"nowrap"}}>{s.value}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* DAILY SECTIONS */}
          <div style={{display:"flex",flexDirection:"column",gap:6}}>
            {weekDays.map(day=>{ const dr=filtered.filter(r=>r.date===day.dateStr); return <DaySection key={day.dateStr} day={day} dayRides={dr} isOpen={!!openDays[day.dateStr]} onToggle={()=>toggleDay(day.dateStr)}/>; })}
          </div>

          {/* ROLLING TOTALS */}
          <div style={{background:"#fff",borderRadius:10,boxShadow:"0 1px 6px rgba(30,77,140,.08)",overflow:"hidden",marginTop:10}}>
            <div style={{background:"linear-gradient(135deg,#0A1628,#1E4D8C)",padding:"6px 12px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"}}
              onClick={()=>setRollingOpen(o=>!o)}>
              <span style={{fontWeight:700,fontSize:11,color:"#fff",letterSpacing:1.2}}>ROLLING WEEK TOTALS</span>
              <div onClick={e=>e.stopPropagation()}>
                <DriverSelect value={rollingDriver} onChange={setRollingDriver} light/>
              </div>
            </div>
            {rollingOpen&&<RollingTable days={weekDays} driver={rollingDriver}/>}
          </div>

          {/* WEEK HISTORY */}
          <div style={{marginTop:14}}>
            <div onClick={()=>setPrevSectionOpen(o=>!o)} style={{background:"linear-gradient(135deg,#1A2A40,#2D4A7A)",borderRadius:prevSectionOpen?"10px 10px 0 0":10,padding:"8px 14px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",boxShadow:"0 1px 6px rgba(30,77,140,.12)"}}>
              <span style={{fontWeight:700,fontSize:13,color:"#fff",letterSpacing:1.5}}>WEEK HISTORY</span>
              <div style={{display:"flex",alignItems:"center",gap:10}}>
                <div onClick={e=>e.stopPropagation()} style={{position:"relative",display:"inline-flex",alignItems:"center"}}>
                  <select value={selectedWeekSunStr} onChange={e=>{setSelectedWeekSunStr(e.target.value);setPrevOpenDays({});}}
                    style={{border:"none",borderRadius:5,padding:"2px 24px 2px 8px",fontSize:11,color:"#0A1628",cursor:"pointer",background:"#fff",appearance:"none",maxWidth:160}}>
                    {allWeeks.map(w=><option key={w.sunStr} value={w.sunStr}>{w.label}</option>)}
                  </select>
                  <span style={{position:"absolute",right:6,pointerEvents:"none",fontSize:10,color:"#1E4D8C"}}>â–¼</span>
                </div>
                <span style={{color:"rgba(255,255,255,.6)",fontSize:11}}>{prevSectionOpen?"â–²":"â–¼"}</span>
              </div>
            </div>

            {prevSectionOpen&&(
              <div style={{background:"#E8EDF5",borderRadius:"0 0 10px 10px",padding:"12px 12px 8px"}}>
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:6}}>
                  <div style={{fontSize:10,fontWeight:700,color:"#6B87B0",letterSpacing:1.5}}>WEEK TOTALS Â· {prevLabel}</div>
                  <DriverSelect value={prevStatsDriver} onChange={setPrevStatsDriver}/>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:10}}>
                  {[{label:"Total Fares",value:"$"+prevWeekFare.toFixed(2),icon:"ðŸ§¾"},{label:"Total Charges",value:"$"+prevWeekCharge.toFixed(2),icon:"ðŸ’³"},{label:"Total Tips",value:"$"+prevWeekTip.toFixed(2),icon:"ðŸ’°"}].map(s=>(
                    <div key={s.label} style={{background:"#fff",borderRadius:8,padding:"10px 12px",boxShadow:"0 1px 4px rgba(30,77,140,.07)",borderTop:"2px solid #4A6A9C"}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                        <div>
                          <div style={{fontSize:9,fontWeight:600,color:"#6B87B0",letterSpacing:1.2,textTransform:"uppercase"}}>{s.label}</div>
                          <div style={{fontSize:20,fontWeight:700,color:"#0A1628",lineHeight:1.1}}>{s.value}</div>
                        </div>
                        <span style={{fontSize:18}}>{s.icon}</span>
                      </div>
                    </div>
                  ))}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:7,marginBottom:10}}>
                  {prevDays.map(day=>{ const dr=rides.filter(r=>r.date===day.dateStr); return <DaySection key={day.dateStr} day={day} dayRides={dr} isOpen={!!prevOpenDays[day.dateStr]} onToggle={()=>togglePrevDay(day.dateStr)}/>; })}
                </div>
                <div style={{background:"#fff",borderRadius:8,overflow:"hidden",boxShadow:"0 1px 4px rgba(30,77,140,.07)"}}>
                  <div style={{background:"linear-gradient(135deg,#2D3A52,#4A6A9C)",padding:"6px 12px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"}}
                    onClick={()=>setPrevRollingOpen(o=>!o)}>
                    <span style={{fontWeight:700,fontSize:11,color:"#fff",letterSpacing:1.2}}>ROLLING WEEK TOTALS</span>
                    <div onClick={e=>e.stopPropagation()}>
                      <DriverSelect value={prevRollingDriver} onChange={setPrevRollingDriver} light/>
                    </div>
                  </div>
                  {prevRollingOpen&&<RollingTable days={prevDays} driver={prevRollingDriver}/>}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* SETTINGS MODAL */}
      {showSettings&&(
        <div className="modal-overlay" onClick={()=>setShowSettings(false)}
          style={{position:"fixed",inset:0,background:"rgba(10,22,40,.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}}>
          <div className="modal-box" onClick={e=>e.stopPropagation()}
            style={{background:"#fff",borderRadius:16,width:"100%",maxWidth:500,boxShadow:"0 20px 60px rgba(10,22,40,.35)",overflow:"hidden"}}>
            <div style={{background:"linear-gradient(135deg,#0A1628,#1E4D8C)",padding:"18px 24px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{fontSize:17,fontWeight:700,color:"#fff",letterSpacing:1.5}}>âš™ SETTINGS</div>
              <button onClick={()=>setShowSettings(false)} style={{background:"rgba(255,255,255,.15)",color:"#fff",width:28,height:28,borderRadius:"50%",fontSize:15,display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
            </div>
            <div style={{padding:"20px 24px",display:"flex",flexDirection:"column",gap:16}}>
              <div>
                <div style={{fontSize:13,fontWeight:600,color:"#0A1628",letterSpacing:.8,marginBottom:6}}>GOOGLE APPS SCRIPT URL</div>
                <input value={settingsUrl} onChange={e=>setSettingsUrl(e.target.value)} placeholder="https://script.google.com/macros/s/â€¦/exec"
                  style={{width:"100%",border:"1.5px solid #D1DEFA",borderRadius:8,padding:"9px 12px",fontSize:12,color:"#0A1628",background:"#F5F8FF",outline:"none"}}/>
                <div style={{fontSize:11,color:"#6B87B0",marginTop:6}}>
                  Paste the URL from your deployed Google Apps Script. See SETUP.md for instructions.
                </div>
              </div>
              <div style={{background:"#F0F4FB",borderRadius:8,padding:"10px 14px",fontSize:11.5,color:"#4A6A9C",lineHeight:1.6}}>
                <strong>Sync status:</strong> {syncStatus} &nbsp;Â·&nbsp;
                {LS.hasPending()?<span style={{color:"#B45309"}}>âš  Unsynced local changes</span>:<span style={{color:"#065F46"}}>âœ“ Up to date</span>}
              </div>
              <div style={{display:"flex",gap:10}}>
                <button onClick={handleSettingsTest} disabled={settingsTesting}
                  style={{flex:1,background:"#F0F4FB",color:"#1E4D8C",borderRadius:10,padding:"12px",fontSize:14,fontWeight:600,letterSpacing:.5,opacity:settingsTesting?.6:1,minHeight:44}}>
                  {settingsTesting?"TESTINGâ€¦":"TEST CONNECTION"}
                </button>
                <button onClick={handleSettingsSave}
                  style={{flex:2,background:"linear-gradient(135deg,#0A1628,#1E4D8C)",color:"#fff",borderRadius:10,padding:"12px",fontSize:14,fontWeight:600,letterSpacing:.5,minHeight:44}}>
                  SAVE & SYNC
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ADD/EDIT MODAL */}
      {showModal&&(
        <div className="modal-overlay" onClick={()=>setShowModal(false)}
          style={{position:"fixed",inset:0,background:"rgba(10,22,40,.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}}>
          <div className="modal-box" onClick={e=>e.stopPropagation()}
            style={{background:"#fff",borderRadius:16,width:"100%",maxWidth:540,boxShadow:"0 20px 60px rgba(10,22,40,.35)",overflow:"hidden"}}>
            <div style={{background:"linear-gradient(135deg,#0A1628,#1E4D8C)",padding:"18px 24px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{fontSize:17,fontWeight:700,color:"#fff",letterSpacing:1.5}}>{editRide?"EDIT RIDE":"BOOK NEW RIDE"}</div>
              <button onClick={()=>setShowModal(false)} style={{background:"rgba(255,255,255,.15)",color:"#fff",width:28,height:28,borderRadius:"50%",fontSize:15,display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
            </div>
            <div style={{padding:"20px 24px",display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,maxHeight:"65vh",overflowY:"auto"}}>
              {!editRide?(
                <>
                  <div style={{gridColumn:"span 2"}}>
                    <label style={labelStyle}>Pickup Address *</label>
                    <input autoFocus value={form.pickup} onChange={e=>setForm(f=>({...f,pickup:e.target.value}))}
                      placeholder="e.g. Bangor International Airport" style={inputStyle}/>
                  </div>
                  {!showFullForm?(
                    <div style={{gridColumn:"span 2"}}>
                      <button onClick={()=>setShowFullForm(true)} type="button"
                        style={{width:"100%",background:"#F0F6FF",color:"#1E4D8C",border:"1px solid #D1DEFA",borderRadius:10,padding:"14px",fontSize:14,fontWeight:600,cursor:"pointer",minHeight:48}}>
                        + Add More Details (driver, dropoff, fare, etc.)
                      </button>
                    </div>
                  ):(
                    <>
                      {[{k:"date",l:"Date *",t:"date"},{k:"time",l:"Time *",t:"time"}].map(({k,l,t})=>(
                        <div key={k}>
                          <label style={labelStyle}>{l}</label>
                          <input type={t} value={form[k]||""} onChange={e=>setForm(f=>({...f,[k]:e.target.value}))} style={inputStyle}/>
                        </div>
                      ))}
                      <div style={{gridColumn:"span 2"}}>
                        <label style={labelStyle}>Dropoff Address</label>
                        <input value={form.dropoff||""} onChange={e=>setForm(f=>({...f,dropoff:e.target.value}))} style={inputStyle}/>
                      </div>
                      <div>
                        <label style={labelStyle}>Driver</label>
                        <select value={form.driver||""} onChange={e=>setForm(f=>({...f,driver:e.target.value}))}
                          style={{...inputStyle,color:form.driver?"#0A1628":"#9FB4D0"}}>
                          <option value="">â€” Unassigned â€”</option>
                          {drivers.active.map(d=><option key={d}>{d}</option>)}
                        </select>
                      </div>
                      {[{k:"fare",l:"Fare ($)"},{k:"charge",l:"Charge ($)"},{k:"tip",l:"Tip ($)"}].map(({k,l})=>(
                        <div key={k}>
                          <label style={labelStyle}>{l}</label>
                          <input type="number" step="0.01" min="0" value={form[k]||""} onChange={e=>setForm(f=>({...f,[k]:e.target.value}))} style={inputStyle}/>
                        </div>
                      ))}
                      <div style={{gridColumn:"span 2"}}>
                        <label style={labelStyle}>Details</label>
                        <textarea value={form.details||""} onChange={e=>setForm(f=>({...f,details:e.target.value}))}
                          placeholder="Any notes, special instructions, or additional infoâ€¦"
                          style={{...inputStyle,resize:"vertical",minHeight:70}}/>
                      </div>
                    </>
                  )}
                </>
              ):(
                <>
                  {[{k:"date",l:"Date *",t:"date"},{k:"time",l:"Time *",t:"time"},{k:"pickup",l:"Pickup Address *"},{k:"dropoff",l:"Dropoff Address"}].map(({k,l,t})=>(
                    <div key={k} style={{gridColumn:(k==="pickup"||k==="dropoff")?"span 2":"auto"}}>
                      <label style={labelStyle}>{l}</label>
                      <input type={t||"text"} value={form[k]||""} onChange={e=>setForm(f=>({...f,[k]:e.target.value}))} style={inputStyle}/>
                    </div>
                  ))}
                  <div>
                    <label style={labelStyle}>Driver</label>
                    <select value={form.driver||""} onChange={e=>setForm(f=>({...f,driver:e.target.value}))}
                      style={{...inputStyle,color:form.driver?"#0A1628":"#9FB4D0"}}>
                      <option value="">â€” Unassigned â€”</option>
                      {drivers.active.map(d=><option key={d}>{d}</option>)}
                    </select>
                  </div>
                  {[{k:"fare",l:"Fare ($)"},{k:"charge",l:"Charge ($)"},{k:"tip",l:"Tip ($)"}].map(({k,l})=>(
                    <div key={k}>
                      <label style={labelStyle}>{l}</label>
                      <input type="number" step="0.01" min="0" value={form[k]||""} onChange={e=>setForm(f=>({...f,[k]:e.target.value}))} style={inputStyle}/>
                    </div>
                  ))}
                  <div style={{gridColumn:"span 2"}}>
                    <label style={labelStyle}>Details</label>
                    <textarea value={form.details||""} onChange={e=>setForm(f=>({...f,details:e.target.value}))}
                      placeholder="Any notes, special instructions, or additional infoâ€¦"
                      style={{...inputStyle,resize:"vertical",minHeight:70}}/>
                  </div>
                </>
              )}
            </div>
            <div style={{padding:"16px 20px",display:"flex",gap:10}}>
              <button onClick={()=>setShowModal(false)} style={{flex:1,background:"#F0F4FB",color:"#6B87B0",borderRadius:10,padding:"14px",fontSize:15,fontWeight:600,minHeight:48}}>CANCEL</button>
              <button onClick={handleSave} style={{flex:2,background:"linear-gradient(135deg,#0A1628,#1E4D8C)",color:"#fff",borderRadius:10,padding:"14px",fontSize:15,fontWeight:600,letterSpacing:.5,minHeight:48}}>
                {editRide?"SAVE CHANGES":"BOOK RIDE"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* DELETE CONFIRM */}
      {deleteConfirm&&(
        <div onClick={()=>setDeleteConfirm(null)}
          style={{position:"fixed",inset:0,background:"rgba(10,22,40,.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}}>
          <div onClick={e=>e.stopPropagation()}
            style={{background:"#fff",borderRadius:14,width:"100%",maxWidth:360,padding:"24px",textAlign:"center",boxShadow:"0 20px 60px rgba(10,22,40,.35)"}}>
            <div style={{fontSize:32,marginBottom:10}}>ðŸ—‘</div>
            <div style={{fontSize:18,fontWeight:700,color:"#0A1628",marginBottom:8}}>DELETE RIDE?</div>
            <div style={{fontSize:14,color:"#6B87B0",marginBottom:24,lineHeight:1.5}}>This will permanently remove the ride and sync the change to Google Sheets.</div>
            <div style={{display:"flex",gap:10}}>
              <button onClick={()=>setDeleteConfirm(null)} style={{flex:1,background:"#F0F4FB",color:"#6B87B0",borderRadius:10,padding:"14px",fontSize:15,fontWeight:600,minHeight:48}}>CANCEL</button>
              <button onClick={()=>handleDelete(deleteConfirm)} style={{flex:1,background:"#991B1B",color:"#fff",borderRadius:10,padding:"14px",fontSize:15,fontWeight:600,minHeight:48}}>DELETE</button>
            </div>
          </div>
        </div>
      )}

      {/* MANAGE DRIVERS */}
      {showDriverModal&&(
        <div onClick={()=>setShowDriverModal(false)}
          style={{position:"fixed",inset:0,background:"rgba(10,22,40,.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}}>
          <div onClick={e=>e.stopPropagation()}
            style={{background:"#fff",borderRadius:16,width:"100%",maxWidth:480,boxShadow:"0 20px 60px rgba(10,22,40,.35)",overflow:"hidden"}}>
            <div style={{background:"linear-gradient(135deg,#0A1628,#1E4D8C)",padding:"18px 24px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{fontSize:17,fontWeight:700,color:"#fff",letterSpacing:1.5}}>MANAGE DRIVERS</div>
              <button onClick={()=>setShowDriverModal(false)} style={{background:"rgba(255,255,255,.15)",color:"#fff",width:28,height:28,borderRadius:"50%",fontSize:15,display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
            </div>
            <div style={{padding:"20px 24px"}}>
              <div style={{marginBottom:20}}>
                <label style={{display:"block",fontSize:12,fontWeight:600,color:"#6B87B0",letterSpacing:.5,marginBottom:8,textTransform:"uppercase"}}>Add New Driver</label>
                <div style={{display:"flex",gap:10}}>
                  <input value={newDriverName} onChange={e=>setNewDriverName(e.target.value)}
                    onKeyPress={e=>e.key==="Enter"&&addDriver()}
                    placeholder="Enter driver name"
                    style={{flex:1,border:"1.5px solid #D1DEFA",borderRadius:10,padding:"12px 14px",fontSize:16,background:"#F9FBFF",outline:"none"}}/>
                  <button onClick={addDriver}
                    style={{background:"linear-gradient(135deg,#0A1628,#1E4D8C)",color:"#fff",borderRadius:10,padding:"0 20px",fontSize:15,fontWeight:600,whiteSpace:"nowrap",minHeight:48}}>
                    ADD
                  </button>
                </div>
              </div>
              <div style={{marginBottom:16}}>
                <div style={{fontSize:12,fontWeight:700,color:"#0A1628",letterSpacing:.5,marginBottom:10,textTransform:"uppercase"}}>Active Drivers ({drivers.active.length})</div>
                {drivers.active.length===0?(
                  <div style={{padding:"14px",background:"#F0F4FB",borderRadius:10,fontSize:14,color:"#6B87B0",fontStyle:"italic",textAlign:"center"}}>No active drivers</div>
                ):(
                  <div style={{display:"flex",flexDirection:"column",gap:8}}>
                    {drivers.active.map(d=>(
                      <div key={d} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 14px",background:"#F9FBFF",borderRadius:10,border:"1px solid #EBF0FA",minHeight:48}}>
                        <span style={{fontSize:15,color:"#0A1628",fontWeight:600}}>{d}</span>
                        <button onClick={()=>archiveDriver(d)}
                          style={{background:"#FFF8E6",color:"#B45309",borderRadius:8,padding:"8px 14px",fontSize:13,fontWeight:600,minHeight:36}}>
                          Archive
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              {drivers.archived.length>0&&(
                <div>
                  <div style={{fontSize:12,fontWeight:700,color:"#6B87B0",letterSpacing:.5,marginBottom:10,textTransform:"uppercase"}}>Archived Drivers ({drivers.archived.length})</div>
                  <div style={{display:"flex",flexDirection:"column",gap:8}}>
                    {drivers.archived.map(d=>(
                      <div key={d} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 14px",background:"#F5F7FB",borderRadius:10,border:"1px solid #E5E9F2",minHeight:48}}>
                        <span style={{fontSize:15,color:"#6B87B0",fontStyle:"italic"}}>{d}</span>
                        <button onClick={()=>unarchiveDriver(d)}
                          style={{background:"#EDFAF3",color:"#065F46",borderRadius:8,padding:"8px 14px",fontSize:13,fontWeight:600,minHeight:36}}>
                          Restore
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* VOICE CONFIRM */}
      {voicePickup&&(
        <div style={{position:"fixed",inset:0,background:"rgba(10,22,40,.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}}>
          <div onClick={e=>e.stopPropagation()}
            style={{background:"#fff",borderRadius:16,width:"100%",maxWidth:440,padding:"24px",boxShadow:"0 20px 60px rgba(10,22,40,.4)"}}>
            <div style={{fontSize:17,fontWeight:700,color:"#0A1628",letterSpacing:.5,marginBottom:16}}>ðŸŽ¤ HEARD THIS PICKUP?</div>
            <div style={{background:"#F0F6FF",borderRadius:10,padding:"14px 16px",fontSize:16,color:"#0A1628",fontWeight:600,marginBottom:12}}>"{voicePickup.text}"</div>
            <div style={{fontSize:13,color:"#9FB4D0",marginBottom:20}}>ðŸ“… {voicePickup.date} Â· â° {voicePickup.time}</div>
            <div style={{display:"flex",gap:10}}>
              <button onClick={()=>setVoicePickup(null)} style={{flex:1,background:"#F0F4FB",color:"#6B87B0",borderRadius:10,padding:"12px",fontSize:14,fontWeight:600,minHeight:44}}>RETRY</button>
              <button onClick={()=>{setVoicePickup(null);openEdit({...EMPTY_FORM,pickup:voicePickup.text,date:voicePickup.date,time:voicePickup.time,status:"Scheduled",id:genId()});}}
                style={{flex:1,background:"#EBF2FF",color:"#1E4D8C",borderRadius:10,padding:"12px",fontSize:14,fontWeight:600,minHeight:44}}>EDIT</button>
              <button onClick={confirmVoiceRide}
                style={{flex:1,background:"linear-gradient(135deg,#0A1628,#1E4D8C)",color:"#fff",borderRadius:10,padding:"12px",fontSize:14,fontWeight:600,minHeight:44}}>CONFIRM</button>
            </div>
          </div>
        </div>
      )}

      {/* TOAST */}
      {toast&&(
        <div style={{position:"fixed",bottom:24,right:16,background:"#0A1628",color:"#fff",padding:"10px 18px",borderRadius:10,fontSize:13,fontWeight:600,boxShadow:"0 4px 20px rgba(10,22,40,.4)",zIndex:2000,maxWidth:280,animation:"toastIn .3s ease"}}>
          {toast}
        </div>
      )}
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>

<script>
  const isPreview = location.hostname.includes('claudeusercontent.com') || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if ('serviceWorker' in navigator && !isPreview) {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW failed:', err));
  }
</script>
</body>
</html>
